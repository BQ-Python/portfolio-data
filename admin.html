<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AltInvest Capital - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{--navy:#0f172a;--gold:#ca8a04;--red:#dc2626;--green:#16a34a;--gray:#e2e8f0;--light:#f8fafc;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Inter',sans-serif;background:#fff;color:#1e293b;padding-top:90px;}
    nav{position:fixed;top:0;width:100%;background:var(--navy);padding:1.5rem 0;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,0.3);}
    .nav{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 5rem;}
    .logo{font-size:2.4rem;font-weight:900;color:white;}.logo span{color:var(--gold);}
    .links a{color:white;text-decoration:none;margin:0 2rem;font-weight:500;transition:.3s;}
    .links a:hover,.links a.active{color:var(--gold);}
    .container{max-width:1400px;margin:0 auto;padding:120px 2rem 80px;text-align:center;}
    h1{font-size:3.6rem;font-weight:800;margin-bottom:4rem;background:linear-gradient(90deg,var(--navy),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    #admin-section{padding:3rem;background:var(--light);border-radius:20px;margin:2rem auto;max-width:900px;text-align:left;}
    label{font-weight:600;margin-top:1rem;display:block;}
    input,select{padding:0.7rem;border:1px solid var(--gray);border-radius:8px;width:100%;margin-top:0.4rem;font-size:1rem;}
    button{background:var(--gold);color:white;border:none;padding:1rem 1.5rem;border-radius:10px;cursor:pointer;font-weight:600;margin-top:1.5rem;}
    button:hover{background:#e4b94c;}
    #admin-message,#comp-message{margin-top:1rem;font-weight:600;}
    .comp-section{margin-top:4rem;padding-top:2rem;border-top:3px dashed #ccc;}
  </style>
</head>
<body>

  <nav>
    <div class="nav">
      <div class="logo">AltInvest<span>.</span></div>
      <div class="links">
        <a href="index.html">Accueil</a>
        <a href="portefeuilles.html">Portefeuilles</a>
        <a href="devis.html">Devis</a>
        <a href="contact.html">Contact</a>
        <a href="#" class="active">Admin</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1>Administration</h1>

    <div id="admin-section">
      <h2>Mise à jour des performances</h2>
      <form id="admin-form">

        <label>Token GitHub (scope repo) :</label>
        <input type="password" id="pat" required placeholder="ghp_...">

        <label>Action :</label>
        <select id="action" required>
          <option value="update">Mettre à jour un portefeuille existant</option>
          <option value="add">Ajouter un nouveau portefeuille</option>
        </select>

        <!-- Toujours visible au début + message clair -->
        <div id="existing-portfolio">
          <label>Portefeuille à modifier :</label>
          <select id="portfolio-select" required>
            <option value="">Chargement de la liste...</option>
          </select>
        </div>

        <div id="new-portfolio" style="display:none;">
          <label>Nom du nouveau portefeuille :</label>
          <input type="text" id="new-name" placeholder="ex: Portefeuille Équilibré" required>
        </div>

        <label>Fichier CSV de performance :</label>
        <input type="file" id="csv-file" accept=".csv" required>

        <button type="submit">Envoyer les performances</button>
      </form>
      <p id="admin-message"></p>

      <div class="comp-section">
        <h2>Mise à jour de la composition globale</h2>
        <label>Fichier CSV de composition :</label>
        <input type="file" id="comp-file" accept=".csv">
        <button type="button" id="update-composition">Mettre à jour composition_portefeuilles.csv</button>
        <p id="comp-message"></p>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = "https://raw.githubusercontent.com/BQ-Python/portfolio-data/main/";
    const PORTFOLIOS_JSON = BASE_URL + "portfolios.json";
    const GITHUB_API = "https://api.github.com/repos/BQ-Python/portfolio-data/contents/";
    const COMP_FILE_NAME = "composition_portefeuilles.csv";

    let PORTFOLIOS = [];

    // Chargement forcé + anti-cache + message ultra clair
    async function loadPortfolios() {
      const select = document.getElementById('portfolio-select');
      const msg = document.getElementById('admin-message');

      try {
        // Anti-cache à mort
        const res = await fetch(PORTFOLIOS_JSON + "?t=" + Date.now());
        if (!res.ok) throw new Error(`Erreur ${res.status} – Vérifie que le fichier existe bien`);

        PORTFOLIOS = await res.json();

        select.innerHTML = '<option value="">-- Choisir un portefeuille --</option>';
        PORTFOLIOS.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.name;
          opt.textContent = p.name;
          select.appendChild(opt);
        });

        msg.textContent = `${PORTFOLIOS.length} portefeuille(s) chargé(s) avec succès !`;
        msg.style.color = 'var(--green)';
      } catch (err) {
        select.innerHTML = '<option value="">ÉCHEC DU CHARGEMENT</option>';
        msg.textContent = "ERREUR : " + err.message + " → Vérifie l'URL : " + PORTFOLIOS_JSON;
        msg.style.color = 'var(--red)';
        console.error(err);
      }
    }

    // Affichage conditionnel
    document.getElementById('action').addEventListener('change', function() {
      const showUpdate = this.value === 'update';
      document.getElementById('existing-portfolio').style.display = showUpdate ? 'block' : 'none';
      document.getElementById('new-portfolio').style.display = showUpdate ? 'none' : 'block';
    });

    // === TOUT LE RESTE (upload perf + composition) IDENTIQUE ET FONCTIONNEL ===
    document.getElementById('admin-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const msg = document.getElementById('admin-message');
      msg.textContent = "Vérification...";

      const pat = document.getElementById('pat').value.trim();
      const action = document.getElementById('action').value;
      const file = document.getElementById('csv-file').files[0];

      if (!pat || !file) return msg.textContent = "Token + fichier requis", msg.style.color='var(--red)';

      try {
        const text = await file.text();
        const lines = text.trim().split('\n');
        if (lines.length < 2) throw new Error("CSV vide");

        const headers = lines[0].split(/\t|,/).map(h=>h.trim().replace(/^"|"$/g,''));
        if (headers.length < 18) throw new Error("Minimum 18 colonnes");

        const base64 = btoa(unescape(encodeURIComponent(text)));
        const auth = { 'Authorization': `token ${pat}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' };

        if (action === 'update') {
          const name = document.getElementById('portfolio-select').value;
          if (!name) throw new Error("Choisis un portefeuille");
          const portfolio = PORTFOLIOS.find(p => p.name === name);
          const shaRes = await fetch(GITHUB_API + portfolio.file, { headers: auth });
          const { sha } = await shaRes.json();

          await fetch(GITHUB_API + portfolio.file, { method:'PUT', headers:auth, body:JSON.stringify({message:`Update ${name}`, content:base64, sha}) });
          msg.textContent = `"${name}" mis à jour !`; msg.style.color='var(--green)';

        } else {
          const name = document.getElementById('new-name').value.trim();
          const slug = `portefeuille_${name.toLowerCase().replace(/[^a-z0-9]+/g,'_')}.csv`;

          await fetch(GITHUB_API + slug, { method:'PUT', headers:auth, body:JSON.stringify({message:`Ajout ${name}`, content:base64}) });

          const jsonRes = await fetch(GITHUB_API + 'portfolios.json', { headers: auth });
          const { sha: jsonSha, content: b64 } = await jsonRes.json();
          const current = JSON.parse(atob(b64));
          current.push({ name, file: slug });
          await fetch(GITHUB_API + 'portfolios.json', { method:'PUT', headers:auth, body:JSON.stringify({message:`Ajout ${name} dans liste`, content:btoa(JSON.stringify(current,null,2)), sha:jsonSha}) });

          msg.textContent = `"${name}" ajouté !`; msg.style.color='var(--green)';
          loadPortfolios();
        }
      } catch(err) {
        msg.textContent = "Erreur : " + err.message; msg.style.color='var(--red)';
      }
    });

    document.getElementById('update-composition').addEventListener('click', async () => {
      const file = document.getElementById('comp-file').files[0];
      const pat = document.getElementById('pat').value.trim();
      const msg = document.getElementById('comp-message');
      if (!pat || !file) return msg.textContent="Token + fichier requis", msg.style.color='var(--red)';

      msg.textContent = "Envoi...";
      try {
        const text = await file.text();
        const base64 = btoa(unescape(encodeURIComponent(text)));
        const headers = { 'Authorization': `token ${pat}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' };

        const shaRes = await fetch(GITHUB_API + COMP_FILE_NAME, { headers });
        const sha = shaRes.ok ? (await shaRes.json()).sha : null;

        await fetch(GITHUB_API + COMP_FILE_NAME, { method:'PUT', headers, body:JSON.stringify({message:"Update composition", content:base64, sha:sha||undefined}) });
        msg.textContent = "Composition mise à jour !"; msg.style.color='var(--green)';
      } catch(err) {
        msg.textContent = "Erreur : "+err.message; msg.style.color='var(--red)';
      }
    });

    // Lancement immédiat
    loadPortfolios();
  </script>
</body>
</html>
