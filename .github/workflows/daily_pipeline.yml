# .github/workflows/daily_pipeline.yml
name: ‚öôÔ∏è Pipeline Quotidien des Portefeuilles (Prix & M√©triques)

# S'ex√©cute du Lundi au Vendredi (jours de bourse) √† 00:00 UTC (1h00 du matin heure de Paris en hiver)
on:
  schedule:
    # 00:00 UTC permet de s'assurer que les prix de la veille sont disponibles.
    - cron: '0 0 * * 1-5'
  workflow_dispatch:

jobs:
  # ===============================================
  # JOB 1 : MISE √Ä JOUR DES PRIX ET SAUVEGARDE CSV
  # ===============================================
  update_prices:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout du code
        uses: actions/checkout@v4
      
      - name: üêç Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: ‚öôÔ∏è Installation des d√©pendances
        run: pip install pandas numpy yfinance firebase-admin --quiet
        
      - name: üöÄ Ex√©cution de la mise √† jour et du calcul
        # Votre script contient les fonctions `update_prices()` et `initialize_firestore()`.
        # L'ex√©cution principale (if __name__ == '__main__':) fait les deux.
        # Nous n'avons besoin que d'un seul run ici.
        run: python update.py
        
      - name: üì¶ Sauvegarde des fichiers de travail (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: prices-data
          # Nous sauvegardons les fichiers mis √† jour pour le prochain run (le Job 2 ne les utilise pas ici, mais le run du lendemain si).
          path: |
            prices_daily.csv
            tickers.csv
            init.done 
            
      - name: üíæ Commit et push des donn√©es mises √† jour (Optionnel mais Recommand√©)
        # Ceci garantit que le code source poss√®de les derni√®res donn√©es CSV.
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"
          git add prices_daily.csv init.done
          # Commit seulement s'il y a des changements (pour ne pas faire un commit vide)
          git commit -m "Daily update: prices data and initialization flag" || echo "No changes to commit"
          git push

  # ===============================================
  # JOB 2 : CALCUL DES M√âTRIQUES ET PUSH FIRESTORE
  # ===============================================
  # Ce Job est D√âPENDANT du Job 1 pour √™tre s√ªr que les prix sont √† jour.
  calculate_metrics:
    needs: update_prices
    runs-on: ubuntu-latest
    
    env:
      FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
    steps:
      - name: ‚¨áÔ∏è Checkout du code
        uses: actions/checkout@v4

      # Note : La r√©cup√©ration d'Artifact n'est pas n√©cessaire car le Job 1 a fait le 'commit'
      # et le Job 2 fait un 'checkout' juste apr√®s, r√©cup√©rant les fichiers mis √† jour.
          
      - name: üêç Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: ‚öôÔ∏è Installation des d√©pendances
        run: pip install pandas numpy firebase-admin yfinance --quiet
        
      - name: üìä Ex√©cution du calcul et Push Firestore
        # Le script principal (update.py) contient √©galement `calculate_and_push_metrics()`
        # Nous l'ex√©cutons √† nouveau, cette fois il ne refera pas `update_prices()`
        # car la date du fichier CSV est tr√®s r√©cente, mais il fera les calculs.
        run: python update.py
