# .github/workflows/daily_pipeline.yml
name: ‚öôÔ∏è Pipeline Quotidien des Portefeuilles (Prix & M√©triques)

# S'ex√©cute du Lundi au Vendredi (jours de bourse) √† 00:00 UTC (1h00 du matin heure de Paris en hiver)
on:
  schedule:
    - cron: '0 0 * * 1-5'
  workflow_dispatch:

jobs:
  # ===============================================
  # JOB 1 : MISE √Ä JOUR DES PRIX ET SAUVEGARDE CSV
  # ===============================================
  update_prices:
    runs-on: ubuntu-latest
    
    # üö® CORRECTION: AJOUT DE L'ENV POUR ACC√âDER √Ä FIREBASE
    env:
      FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
    steps:
      - name: ‚¨áÔ∏è Checkout du code
        uses: actions/checkout@v4
      
      - name: üêç Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: ‚öôÔ∏è Installation des d√©pendances
        run: pip install pandas numpy yfinance firebase-admin --quiet
        
      - name: üöÄ Ex√©cution de la mise √† jour et du calcul
        run: python update.py
        
      # ... (Pas de changement dans les √©tapes Artifact et Commit)
      
      - name: üì¶ Sauvegarde des fichiers de travail (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: prices-data
          path: |
            prices_daily.csv
            tickers.csv
            init.done 
            
      - name: üíæ Commit et push des donn√©es mises √† jour
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"
          git add prices_daily.csv init.done
          git commit -m "Daily update: prices data and initialization flag" || echo "No changes to commit"
          git push

  # ===============================================
  # JOB 2 : CALCUL DES M√âTRIQUES ET PUSH FIRESTORE
  # ===============================================
  calculate_metrics:
    needs: update_prices
    runs-on: ubuntu-latest
    
    env:
      FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
    steps:
      # ... (√©tapes pr√©c√©dentes non modifi√©es)
        
      - name: üìä Ex√©cution du calcul et Push Firestore
        # Remplacer l'√©tape run: par ceci
        run: |
          echo "--- D√©bogage des fichiers CSV ---"
          ls -l prices_daily.csv tickers.csv
          
          echo "--- 5 premi√®res lignes de prices_daily.csv ---"
          head -n 5 prices_daily.csv
          
          echo "--- 5 derni√®res lignes de prices_daily.csv ---"
          tail -n 5 prices_daily.csv
          
          echo "--- Ex√©cution du script Python ---"
          python update.py
