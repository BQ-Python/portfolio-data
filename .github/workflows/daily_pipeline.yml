# .github/workflows/daily_pipeline.yml
name: ‚öôÔ∏è Pipeline Quotidien des Portefeuilles (Prix & M√©triques)

# S'ex√©cute du Lundi au Vendredi (jours de bourse) √† 00:00 UTC
on:
  schedule:
    # 00:00 UTC permet de s'assurer que les prix de la veille sont disponibles.
    - cron: '0 0 * * 1-5'
  workflow_dispatch:

jobs:
  # ===============================================
  # JOB 1 : MISE √Ä JOUR DES PRIX ET SAUVEGARDE CSV
  # ===============================================
  update_prices:
    runs-on: ubuntu-latest
    
    # üîë Assure l'acc√®s aux secrets Firebase pour l'initialisation √©ventuelle
    env:
      FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
    steps:
      - name: ‚¨áÔ∏è Checkout du code
        uses: actions/checkout@v4
      
      - name: üêç Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: ‚öôÔ∏è Installation des d√©pendances
        run: pip install pandas numpy yfinance firebase-admin --quiet
        
      - name: üöÄ Ex√©cution de la mise √† jour et du calcul
        # Le script met √† jour prices_daily.csv et init.done localement
        run: python update.py
        
      - name: üì¶ Sauvegarde des fichiers de travail (Artifacts)
        # Ceci garantit le transfert des fichiers mis √† jour vers le Job 2
        uses: actions/upload-artifact@v4
        with:
          name: prices-data
          path: |
            prices_daily.csv
            tickers.csv
            init.done 
            
      - name: üíæ Commit et push des donn√©es mises √† jour (Persistance √† long terme)
        # Ceci garantit que le code source poss√®de les derni√®res donn√©es CSV.
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"
          git add prices_daily.csv init.done
          # Commit seulement s'il y a des changements
          git commit -m "Daily update: prices data and initialization flag" || echo "No changes to commit"
          git push

  # ===============================================
  # JOB 2 : CALCUL DES M√âTRIQUES ET PUSH FIRESTORE
  # ===============================================
  calculate_metrics:
    needs: update_prices
    runs-on: ubuntu-latest
    
    # üîë Assure l'acc√®s aux secrets Firebase pour le push final
    env:
      FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
    steps:
      - name: ‚¨áÔ∏è Checkout du code (R√©cup√©ration du script Python)
        uses: actions/checkout@v4

      - name: üì• R√©cup√©ration des fichiers de prix (ARTIFACTS)
        # T√©l√©charge les fichiers g√©n√©r√©s par le Job 1 dans ce r√©pertoire de travail
        uses: actions/download-artifact@v4
        with:
          name: prices-data
          
      - name: üêç Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: ‚öôÔ∏è Installation des d√©pendances
        run: pip install pandas numpy firebase-admin yfinance --quiet
        
      - name: üìä Ex√©cution du calcul et Push Firestore
        # Le script s'ex√©cute, trouve les fichiers CSV gr√¢ce √† l'Artifact, calcule les m√©triques,
        # g√®re la logique du "Jour Z√©ro", et envoie le tout √† Firestore.
        run: python update.py
