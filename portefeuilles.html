<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nos Portefeuilles | AltInvest Capital</title>
  <link href="https://fonts.googleapis.com/css2?family=Satoshi:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--n:#0f172a;--g:#ca8a04;--l:#f8fafc;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Satoshi',sans-serif;background:#fff;color:#1e293b;padding-top:90px;}
    nav{position:fixed;top:0;width:100%;background:var(--n);padding:1.5rem 0;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,0.3);}
    .nav{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 5rem;}
    .logo{font-size:2.4rem;font-weight:900;color:white;}.logo span{color:var(--g);}
    .links a{color:white;text-decoration:none;margin:0 2.5rem;font-weight:500;transition:.3s;}
    .links a:hover,.links a.active{color:var(--g);}
    .container{max-width:1400px;margin:0 auto;padding:120px 2rem;}
    h1{text-align:center;font-size:3.8rem;margin-bottom:5rem;color:var(--n);}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(520px,1fr));gap:4rem;}
    .card{background:white;border-radius:20px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,0.08);transition:.4s;cursor:pointer;}
    .card:hover{transform:translateY(-12px);box-shadow:0 35px 80px rgba(0,0,0,0.14);}
    .header{background:linear-gradient(135deg,var(--n),#1e3a8a);padding:3.5rem 2rem;text-align:center;color:white;}
    .header h3{font-size:2.4rem;font-weight:700;}
    .metrics{padding:3rem;display:grid;grid-template-columns:1fr 1fr;gap:1.8rem;}
    .kpi{background:var(--l);padding:1.8rem;border-radius:16px;text-align:center;}
    .kpi strong{font-size:2.8rem;display:block;color:var(--g);font-weight:700;}
    .kpi.red strong{color:#dc2626;}
    .kpi small{font-size:0.95rem;color:#64748b;}

    /* Modal épurée */
    #modal{display:none;position:fixed;inset:0;background:rgba(15,23,42,0.97);backdrop-filter:blur(12px);z-index:2000;align-items:center;justify-content:center;padding:2rem;}
    #modal.active{display:flex;}
    .modal-content{background:white;border-radius:24px;max-width:1500px;width:100%;box-shadow:0 40px 100px rgba(0,0,0,0.4);}
    .modal-header{background:var(--n);color:white;padding:2rem 3rem;display:flex;justify-content:space-between;align-items:center;border-radius:24px 24px 0 0;}
    .modal-header h2{font-size:2.4rem;margin:0;}
    .close{font-size:3.5rem;cursor:pointer;opacity:0.8;transition:.3s;}
    .close:hover{opacity:1;}
    .modal-body{padding:3rem;}
    .kpi-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:2rem;margin-bottom:3rem;}
    .kpi-big{background:var(--l);padding:1.8rem 2rem;border-radius:16px;text-align:center;border-left:5px solid var(--g);}
    .kpi-big strong{font-size:3rem;color:var(--g);}
    .kpi-big.red{border-left-color:#dc2626;}
    .kpi-big.red strong{color:#dc2626;}
    .controls{text-align:center;margin:2rem 0;}
    .controls select,.controls label{margin:0 0.8rem;padding:0.9rem 1.8rem;font-size:1.1rem;border-radius:12px;border:2px solid #cbd5e1;}
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(600px,1fr));gap:3rem;margin:3rem 0;}
    canvas{background:white;border-radius:16px;padding:1.5rem;box-shadow:0 10px 30px rgba(0,0,0,0.06);}
    table{width:100%;border-collapse:collapse;margin-top:2rem;}
    th,td{padding:1rem;border-bottom:1px solid #e2e8f0;text-align:left;}
    th{background:var(--l);font-weight:700;color:var(--n);}
    tr:last-child td{border-bottom:none;}
    .error{text-align:center;color:#dc2626;font-size:1.2rem;padding:2rem;}
  </style>
</head>
<body>

<nav>
  <div class="nav">
    <div class="logo">AltInvest<span>.</span></div>
    <div class="links">
      <a href="index.html">Accueil</a>
      <a href="portefeuilles.html" class="active">Portefeuilles</a>
      <a href="devis.html">Devis</a>
      <a href="contact.html">Contact</a>
    </div>
  </div>
</nav>

<div class="container">
  <h1>Nos Portefeuilles</h1>
  <div class="grid" id="grid"></div>
</div>

<!-- Modal épurée -->
<div id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">Portefeuille</h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="kpi-bar" id="kpi-bar"></div>
      
      <div class="controls">
        <select id="granularite" onchange="drawCharts()">
          <option value="daily">Journalier</option>
          <option value="weekly">Hebdomadaire</option>
          <option value="monthly" selected>Mensuel</option>
        </select>
        <label><input type="checkbox" checked onchange="drawCharts()"> Portefeuille</label>
        <label><input type="checkbox" checked onchange="drawCharts()"> S&P 500</label>
        <label><input type="checkbox" checked onchange="drawCharts()"> NASDAQ</label>
      </div>

      <div class="charts">
        <canvas id="perf" width="600" height="400"></canvas>
        <canvas id="vol" width="600" height="400"></canvas>
        <canvas id="dd" width="600" height="400"></canvas>
        <canvas id="ret" width="600" height="400"></canvas>
      </div>

      <h3 style="text-align:center;margin:3rem 0 1.5rem;font-size:1.8rem;">Composition actuelle</h3>
      <table><thead><tr><th>Actif</th><th>Ticker</th><th style="text-align:right;">Pondération</th></tr></thead><tbody id="comp"></tbody></table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const PORTFOLIOS = [
  { name: "Portefeuille Croissance", csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_portefeuille_croissance_v2.csv" },
  { name: "Portefeuille Défensif",   csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_portefeuille_defensif_v2.csv" }
];
const COMP_CSV = "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/composition_portefeuilles%20(3).csv";

let currentData = [];
let charts = {};

function closeModal() {
  document.getElementById('modal').classList.remove('active');
  document.body.style.overflow = '';
  Object.values(charts).forEach(c => c?.destroy());
  charts = {};
}

async function loadCards() {
  const grid = document.getElementById('grid');
  grid.innerHTML = '<div class="error">Chargement des performances...</div>';

  for (const p of PORTFOLIOS) {
    try {
      const response = await fetch(p.csv);
      if (!response.ok) throw new Error('CSV not found');
      const txt = await response.text();
      const lines = txt.trim().split('\n');
      if (lines.length < 2) throw new Error('Empty CSV');
      const last = lines[lines.length-1].split(',');
      const perf = parseFloat(last[1] || 0).toFixed(1);
      const vol = parseFloat(last[6] || 0).toFixed(1);
      const dd = parseFloat(last[8] || 0).toFixed(1);

      grid.innerHTML += `
        <div class="card" onclick="openModal('${p.name}', '${p.csv}')">
          <div class="header"><h3>${p.name}</h3></div>
          <div class="metrics">
            <div class="kpi"><strong>${perf}%</strong><small>Perf. cumulée</small></div>
            <div class="kpi"><strong>${vol}%</strong><small>Vol. mensuelle</small></div>
            <div class="kpi red"><strong>${dd}%</strong><small>Drawdown max</small></div>
            <div class="kpi"><strong>1.9</strong><small>Sharpe</small></div>
          </div>
        </div>`;
    } catch(e) {
      console.error(e);
      grid.innerHTML += `<div class="error">Erreur pour ${p.name}: ${e.message}</div>`;
    }
  }
}

async function openModal(name, url) {
  closeModal(); // Nettoie avant
  document.getElementById('modal-title').textContent = name;
  document.getElementById('modal').classList.add('active');
  document.body.style.overflow = 'hidden';

  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('CSV not found');
    const txt = await response.text();
    const lines = txt.trim().split('\n').slice(1);
    if (lines.length === 0) throw new Error('No data in CSV');
    currentData = lines.map(l => {
      const v = l.split(',');
      return {
        date: v[0],
        port: +v[1], sp: +v[2], nas: +v[3],
        volD: +v[4], volW: +v[5], volM: +v[6],
        ddC: +v[7], ddM: +v[8],
        retPD: +v[9], retPW: +v[10], retPM: +v[11],
        retSD: +v[12], retSW: +v[13], retSM: +v[14],
        retND: +v[15], retNW: +v[16], retNM: +v[17]
      };
    });

    const last = currentData[currentData.length-1];
    document.getElementById('kpi-bar').innerHTML = `
      <div class="kpi-big"><strong>${last.port.toFixed(1)}%</strong><div>Performance cumulée</div></div>
      <div class="kpi-big"><strong>${last.volM.toFixed(1)}%</strong><div>Volatilité annualisée</div></div>
      <div class="kpi-big red"><strong>${last.ddM.toFixed(1)}%</strong><div>Drawdown max</div></div>
      <div class="kpi-big"><strong>1.9</strong><div>Ratio de Sharpe</div></div>
    `;

    // Composition
    const compResponse = await fetch(COMP_CSV);
    if (compResponse.ok) {
      const compTxt = await compResponse.text();
      const rows = compTxt.trim().split('\n').slice(1).filter(r => r.startsWith(name));
      document.getElementById('comp').innerHTML = rows.map(r => {
        const [_,actif,ticker,weight] = r.split(',');
        return `<tr><td><strong>${actif}</strong></td><td>${ticker}</td><td style="text-align:right;font-weight:700;">${weight}</td></tr>`;
      }).join('');
    } else {
      document.getElementById('comp').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#64748b;">Composition non disponible</td></tr>';
    }

    drawCharts();
  } catch(e) {
    console.error(e);
    document.getElementById('kpi-bar').innerHTML = '<div class="error">Erreur de chargement des données</div>';
    document.getElementById('comp').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#dc2626;">Données non disponibles</td></tr>';
  }
}

function drawCharts() {
  const tf = document.getElementById('granularite').value;
  const showP = document.querySelectorAll('#modal input[type=checkbox]')[0].checked;
  const showSP = document.querySelectorAll('#modal input[type=checkbox]')[1].checked;
  const showNAS = document.querySelectorAll('#modal input[type=checkbox]')[2].checked;

  const volKey = tf==='daily'?'volD':tf==='weekly'?'volW':'volM';
  const retKey = tf==='daily'?'retPD':tf==='weekly'?'retPW':'retPM';
  const retSKey = tf==='daily'?'retSD':tf==='weekly'?'retSW':'retSM';
  const retNKey = tf==='daily'?'retND':tf==='weekly'?'retNW':'retNM';

  const labels = currentData.map(d => d.date.slice(5));

  Object.values(charts).forEach(c => c?.destroy());

  charts.perf = new Chart('perf', {type:'line',data:{labels,datasets:[
    ...(showP ? [{label:'Portefeuille',data:currentData.map(d=>d.port),borderColor:'#ca8a04',borderWidth:2.5,tension:0.3,pointRadius:0}] : []),
    ...(showSP ? [{label:'S&P 500',data:currentData.map(d=>d.sp),borderColor:'#64748b',borderWidth:1.5,tension:0.3,pointRadius:0,borderDash:[5,5]}] : []),
    ...(showNAS ? [{label:'NASDAQ',data:currentData.map(d=>d.nas),borderColor:'#94a3b8',borderWidth:1.5,tension:0.3,pointRadius:0,borderDash:[8,8]}] : [])
  ]},options:{responsive:true,plugins:{legend:{position:'top',labels:{font:{size:14}}}},scales:{y:{grid:{color:'#f1f5f9'},ticks:{font:{size:13}}}}}});

  charts.vol = new Chart('vol', {type:'line',data:{labels,datasets:[{
    label:'Volatilité annualisée',data:currentData.map(d=>d[volKey]),borderColor:'#ca8a04',backgroundColor:'rgba(202,138,4,0.08)',fill:true,borderWidth:2,tension:0.3
  }]},options:{responsive:true,plugins:{title:{display:true,text:'Volatilité (%)',font:{size:16}}}},scales:{y:{grid:{color:'#f1f5f9'}}}});

  charts.dd = new Chart('dd', {type:'line',data:{labels,datasets:[
    {label:'Drawdown actuel',data:currentData.map(d=>d.ddC),borderColor:'#dc2626',backgroundColor:'rgba(220,38,38,0.12)',fill:true,borderWidth:2},
    {label:'Drawdown max',data:currentData.map(d=>d.ddM),borderColor:'#7f1d1d',borderWidth:1.5,borderDash:[6,6]}
  ]},options:{responsive:true,plugins:{title:{display:true,text:'Drawdown (%)',font:{size:16}}}},scales:{y:{grid:{color:'#f1f5f9'}}}});

  charts.ret = new Chart('ret', {type:'bar',data:{labels,datasets:[
    ...(showP ? [{label:'Portefeuille',data:currentData.map(d=>d[retKey]),backgroundColor:'#ca8a04'}] : []),
    ...(showSP ? [{label:'S&P 500',data:currentData.map(d=>d[retSKey]),backgroundColor:'#e2e8f0'}] : []),
    ...(showNAS ? [{label:'NASDAQ',data:currentData.map(d=>d[retNKey]),backgroundColor:'#cbd5e1'}] : [])
  ]},options:{responsive:true,plugins:{title:{display:true,text:`Retour ${tf==='monthly'?'mensuel':tf==='weekly'?'hebdomadaire':'journalier'} (%)`,font:{size:16}}}},scales:{y:{grid:{color:'#f1f5f9'}}}}});
}

loadCards();
</script>
</body>
</html>
