<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AltInvest Capital - Portefeuilles</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    :root {
      --navy: #0f172a;
      --gold: #ca8a04;
      --slate: #64748b;
      --light: #f8fafc;
      --gray: #e2e8f0;
      --red: #dc2626;
      --green: #16a34a;
      --purple: #7c3aed;
      --orange: #ea580c;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #fff; color: #1e293b; padding-top: 90px; line-height: 1.6; }
    nav { position: fixed; top: 0; width: 100%; background: var(--navy); padding: 1.5rem 0; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .nav { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 5rem; }
    .logo { font-size: 2.4rem; font-weight: 900; color: white; }
    .logo span { color: var(--gold); }
    .links a { color: white; text-decoration: none; margin: 0 2rem; font-weight: 500; transition: .3s; }
    .links a:hover, .links a.active { color: var(--gold); }
    .container { max-width: 1400px; margin: 0 auto; padding: 120px 2rem 80px; text-align: center; }
    h1 { font-size: 3.6rem; font-weight: 800; margin-bottom: 4rem; background: linear-gradient(90deg, var(--navy), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(460px, 1fr)); gap: 2.5rem; margin-top: 3rem; }
    .card { background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.08); transition: all .4s; cursor: pointer; }
    .card:hover { transform: translateY(-16px); box-shadow: 0 30px 70px rgba(0,0,0,0.15); }
    .card-header { background: linear-gradient(135deg, var(--navy), #1e40af); padding: 3rem 2rem; color: white; text-align: center; }
    .card-header h3 { font-size: 2.2rem; font-weight: 700; }
    .metrics { padding: 2.5rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.2rem; }
    .kpi { text-align: center; padding: 1rem; background: var(--light); border-radius: 14px; }
    .kpi strong { display: block; font-size: 2rem; font-weight: 800; color: var(--gold); }
    .kpi.red strong { color: var(--red); }
    .kpi.green strong { color: var(--green); }
    .kpi small { font-size: 0.85rem; color: var(--slate); display: block; margin-top: 4px; }

    #modal { display: none; position: fixed; inset: 0; background: rgba(15,23,42,0.97); backdrop-filter: blur(16px); z-index: 2000; align-items: center; justify-content: center; padding: 2rem; overflow-y: auto; }
    #modal.active { display: flex; }
    .modal-content { background: white; border-radius: 28px; max-width: 1400px; width: 95%; max-height: 95vh; overflow-y: auto; box-shadow: 0 40px 100px rgba(0,0,0,0.5); }
    .modal-header { background: var(--navy); color: white; padding: 2rem 3rem; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 2.4rem; font-weight: 800; }
    .close { font-size: 3rem; cursor: pointer; opacity: 0.8; transition: .3s; }
    .close:hover { opacity: 1; transform: rotate(90deg); }
    .modal-body { padding: 3rem 4rem 4rem; }
    .kpi-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
    .kpi-big { background: var(--light); padding: 1.8rem; border-radius: 18px; text-align: center; border-left: 6px solid var(--gold); }
    .kpi-big.red { border-left-color: var(--red); }
    .kpi-big.red strong { color: var(--red); }
    .kpi-big strong { font-size: 2.5rem; font-weight: 800; color: var(--gold); display: block; }
    .kpi-big div { font-size: 0.95rem; color: var(--slate); margin-top: 6px; }
    .chart-wrapper { position: relative; height: 420px; background: white; border-radius: 20px; padding: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.07); margin: 3rem 0; }
    .chart-controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 15px; }
    .chart-btn { padding: 9px 16px; border: none; border-radius: 10px; background: #e2e8f0; color: #1e293b; font-size: 0.95rem; cursor: pointer; transition: .2s; font-weight: 600; }
    .chart-btn.active, .chart-btn:hover { background: var(--gold); color: white; }
    .comp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; margin-top: 3rem; align-items: start; }
    @media (max-width: 992px) { .comp-grid { grid-template-columns: 1fr; } }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.9rem; text-align: left; border-bottom: 1px solid var(--gray); }
    th { background: var(--light); font-weight: 600; color: var(--navy); }
  </style>
</head>
<body>

  <nav>
    <div class="nav">
      <div class="logo">AltInvest<span>.</span></div>
      <div class="links">
        <a href="index.html">Accueil</a>
        <a href="#" class="active">Portefeuilles</a>
        <a href="devis.html">Devis</a>
        <a href="contact.html">Contact</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1>Nos Portefeuilles d'Investissement</h1>
    <div class="grid" id="grid"></div>
  </div>

  <div id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title"></h2>
        <span class="close" onclick="closeModal()">x</span>
      </div>
      <div class="modal-body">
        <div class="kpi-bar" id="kpi-bar"></div>

        <div class="chart-wrapper">
          <div class="chart-controls" id="mainControls"></div>
          <canvas id="mainChart"></canvas>
        </div>

        <div class="chart-wrapper">
          <div class="chart-controls" id="detailControls"></div>
          <canvas id="detailChart"></canvas>
        </div>

        <div class="chart-wrapper">
          <div class="chart-controls" id="varControls"></div>
          <canvas id="varChart"></canvas>
        </div>

        <h3 style="text-align:center;margin:4rem 0 2rem;font-size:2rem;font-weight:700;">Composition Actuelle</h3>
        <div class="comp-grid">
          <div class="chart-wrapper" style="height:350px;"><canvas id="pieChart"></canvas></div>
          <table><thead><tr><th>Actif</th><th>Ticker</th><th style="text-align:right;">Pondération</th></tr></thead><tbody id="compTable"></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = "https://raw.githubusercontent.com/BQ-Python/portfolio-data/main/";
    const PORTFOLIOS_JSON = BASE_URL + "portfolios.json";
    const COMP_CSV = BASE_URL + "composition_portefeuilles.csv";

    let PORTFOLIOS = [];
    let rawData = [], mainChart = null, detailChart = null, varChart = null, pieChart = null;
    let currentPortfolioName = "";

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      document.body.style.overflow = '';
      [mainChart, detailChart, varChart, pieChart].forEach(c => c?.destroy());
    }

    function parseLine(line) {
      const cols = line.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
      if (cols.length < 19) return null;
      const date = new Date(cols[0]);
      if (isNaN(date)) return null;

      const port100 = parseFloat(cols[1]) || 100;
      const sp100 = parseFloat(cols[2]) || 100;
      const nas100 = parseFloat(cols[3]) || 100;
      const dailyRet = parseFloat(cols[9]) / 100 || 0; // Return_Port_Daily

      return {
        date,
        port100, sp100, nas100,
        port: port100 - 100,
        sp: sp100 - 100,
        nas: nas100 - 100,
        volM: parseFloat(cols[6]) || 0,
        ddC: parseFloat(cols[7]) || 0,
        ddM: parseFloat(cols[8]) || 0,
        sharpe: parseFloat(cols[18]) || 0,
        dailyRet
      };
    }

    async function loadPortfolios() {
      const res = await fetch(PORTFOLIOS_JSON);
      PORTFOLIOS = await res.json();
      PORTFOLIOS = PORTFOLIOS.map(p => ({ ...p, csv: BASE_URL + p.file }));
      await loadCards();
    }

    async function loadCards() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      const currentYear = new Date().getFullYear();

      for (const p of PORTFOLIOS) {
        try {
          const text = await fetch(p.csv).then(r => r.text());
          const data = text.trim().split('\n').slice(1).map(parseLine).filter(Boolean);
          if (data.length === 0) continue;

          const last = data[data.length - 1];
          const first = data[0];
          const firstYTD = data.find(d => d.date.getFullYear() === currentYear) || first;

          const ytd = ((last.port100 / firstYTD.port100) - 1) * 100;
          const years = (last.date - first.date) / (1000 * 60 * 60 * 24 * 365.25);
          const cagr = years > 0 ? (Math.pow(last.port100 / 100, 1 / years) - 1) * 100 : 0;
          const avgSharpe = data.reduce((s, d) => s + (d.sharpe || 0), 0) / data.filter(d => d.sharpe).length || 0;

          const card = document.createElement('div');
          card.className = 'card';
          card.onclick = () => openModal(p.name, p.csv);
          card.innerHTML = `
            <div class="card-header"><h3>${p.name}</h3></div>
            <div class="metrics">
              <div class="kpi"><strong>${last.port.toFixed(1)}%</strong><small>Perf. cumulée</small></div>
              <div class="kpi ${ytd >= 0 ? 'green' : 'red'}"><strong>${ytd.toFixed(1)}%</strong><small>YTD ${currentYear}</small></div>
              <div class="kpi"><strong>${cagr.toFixed(1)}%</strong><small>Perf. annualisée</small></div>
              <div class="kpi"><strong>${last.volM.toFixed(1)}%</strong><small>Volatilité 21j</small></div>
              <div class="kpi red"><strong>${last.ddM.toFixed(1)}%</strong><small>Drawdown max</small></div>
              <div class="kpi"><strong>${avgSharpe.toFixed(2)}</strong><small>Sharpe moyen</small></div>
            </div>`;
          grid.appendChild(card);
        } catch (e) { console.error(e); }
      }
    }

    async function openModal(name, url) {
      closeModal();
      currentPortfolioName = name;
      document.getElementById('modal-title').textContent = name;
      document.getElementById('modal').classList.add('active');
      document.body.style.overflow = 'hidden';

      const text = await fetch(url).then(r => r.text());
      rawData = text.trim().split('\n').slice(1).map(parseLine).filter(Boolean);

      updateKPIs();
      drawMainChart();
      drawDetailChart();
      drawVaRChart();
      await loadComposition(name);
    }

    function updateKPIs() {
      const last = rawData[rawData.length - 1];
      const first = rawData[0];
      const currentYear = new Date().getFullYear();
      const firstYTD = rawData.find(d => d.date.getFullYear() === currentYear) || first;
      const ytd = ((last.port100 / firstYTD.port100) - 1) * 100;
      const years = (last.date - first.date) / (1000 * 60 * 60 * 24 * 365.25);
      const cagr = years > 0 ? (Math.pow(last.port100 / 100, 1 / years) - 1) * 100 : 0;
      const avgSharpe = rawData.reduce((s, d) => s + (d.sharpe || 0), 0) / rawData.filter(d => d.sharpe).length || 0;

      document.getElementById('kpi-bar').innerHTML = `
        <div class="kpi-big"><strong>${last.port.toFixed(1)}%</strong><div>Performance cumulée</div></div>
        <div class="kpi-big ${ytd >= 0 ? '' : 'red'}"><strong>${ytd.toFixed(1)}%</strong><div>YTD ${currentYear}</div></div>
        <div class="kpi-big"><strong>${cagr.toFixed(1)}%</strong><div>Performance annualisée</div></div>
        <div class="kpi-big"><strong>${last.volM.toFixed(1)}%</strong><div>Volatilité (21j)</div></div>
        <div class="kpi-big red"><strong>${last.ddM.toFixed(1)}%</strong><div>Drawdown max</div></div>
        <div class="kpi-big"><strong>${avgSharpe.toFixed(2)}</strong><div>Sharpe moyen (21j)</div></div>`;
    }

    function createButtons(id, chart) {
      const div = document.getElementById(id);
      div.innerHTML = '';
      ['1M', '3M', '6M', 'YTD', '1A', '3A', 'Tout'].forEach((l, i) => {
        const b = document.createElement('button');
        b.className = 'chart-btn' + (i === 6 ? ' active' : '');
        b.textContent = l;
        b.onclick = () => {
          div.querySelectorAll('.chart-btn').forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          if (l === 'Tout') chart.resetZoom();
          else if (l === 'YTD') chart.zoomScale('x', { min: new Date(`${new Date().getFullYear()}-01-01`).getTime(), max: Date.now() });
          else {
            const days = { '1M': 30, '3M': 90, '6M': 180, '1A': 365, '3A': 1095 }[l];
            chart.zoomScale('x', { min: Date.now() - days * 86400000, max: Date.now() });
          }
        };
        div.appendChild(b);
      });
    }

    function drawMainChart() {
      if (mainChart) mainChart.destroy();

      const allValues = [...rawData.map(d => d.port), ...rawData.map(d => d.sp), ...rawData.map(d => d.nas)];
      const minVal = Math.min(...allValues);
      const maxVal = Math.max(...allValues);
      const range = maxVal - minVal;
      const yMin = Math.max(Math.floor(minVal - range * 0.12), -30);
      const yMax = Math.ceil(maxVal + range * 0.08);

      mainChart = new Chart(document.getElementById('mainChart'), {
        type: 'line',
        data: {
          labels: rawData.map(d => d.date),
          datasets: [
            { label: currentPortfolioName, data: rawData.map(d => d.port), borderColor: '#ca8a04', backgroundColor: 'rgba(202,138,4,0.08)', fill: true, tension: 0.38, borderWidth: 4.5, pointRadius: 0 },
            { label: 'S&P 500', data: rawData.map(d => d.sp), borderColor: '#64748b', borderWidth: 2.8, borderDash: [10, 7], tension: 0.38, pointRadius: 0 },
            { label: 'NASDAQ 100', data: rawData.map(d => d.nas), borderColor: '#94a3b8', borderWidth: 2.5, borderDash: [14, 9], tension: 0.38, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top', labels: { font: { size: 14, weight: 600 } } },
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%` } },
            zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } }
          },
          scales: {
            x: { type: 'time', time: { unit: 'month', displayFormats: { month: 'MMM yyyy' } }, grid: { display: false } },
            y: { min: yMin, max: yMax, ticks: { callback: v => v + '%', stepSize: 10 }, grid: { color: 'rgba(0,0,0,0.06)' } }
          }
        }
      });
      createButtons('mainControls', mainChart);
    }

    function drawDetailChart() {
      if (detailChart) detailChart.destroy();
      detailChart = new Chart(document.getElementById('detailChart'), {
        type: 'line',
        data: {
          labels: rawData.map(d => d.date),
          datasets: [
            { label: 'Volatilité annualisée (21j)', data: rawData.map(d => d.volM), borderColor: '#ca8a04', backgroundColor: 'rgba(202,138,4,0.15)', fill: true, tension: 0.4 },
            { label: 'Drawdown actuel', data: rawData.map(d => d.ddC), borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.15)', fill: true, tension: 0.4 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top' }, title: { display: true, text: 'Risque : Volatilité & Drawdown', font: { size: 16 } } },
          scales: { x: { type: 'time' }, y: { ticks: { callback: v => v + '%' } } }
        }
      });
      createButtons('detailControls', detailChart);
    }

    function drawVaRChart() {
      if (varChart) varChart.destroy();

      const returns = rawData.map(d => d.dailyRet);
      const var95 = [];
      const var99 = [];

      for (let i = 29; i < returns.length; i++) {
        const window = returns.slice(i - 29, i + 1);
        window.sort((a, b) => a - b);
        var95.push(window[Math.floor(0.05 * window.length)] * 100);
        var99.push(window[Math.floor(0.01 * window.length)] * 100);
      }

      const labels = rawData.slice(29).map(d => d.date);

      varChart = new Chart(document.getElementById('varChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'VaR 95% (30 jours)', data: var95, borderColor: '#ea580c', backgroundColor: 'rgba(234,88,12,0.1)', fill: true, tension: 0.4, borderWidth: 3 },
            { label: 'VaR 99% (30 jours)', data: var99, borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.1)', fill: true, tension: 0.4, borderWidth: 3 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Value at Risk Historique (30 jours glissants)', font: { size: 16 } },
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%` } }
          },
          scales: {
            x: { type: 'time', time: { unit: 'month' } },
            y: { ticks: { callback: v => v.toFixed(1) + '%' }, beginAtZero: false }
          }
        }
      });
      createButtons('varControls', varChart);
    }

    async function loadComposition(name) {
      try {
        const text = await fetch(COMP_CSV).then(r => r.text());
        const rows = text.trim().split('\n').slice(1);
        const relevant = rows.filter(r => r.split(',')[0].trim() === name);
        const table = document.getElementById('compTable');
        table.innerHTML = '';
        const labels = [], values = [], colors = ['#ca8a04','#e4b94c','#f5d28a','#b37a00','#8c6200','#6b4d00','#4a3800','#ffd700','#ffcc00','#ffb300'];

        relevant.forEach(r => {
          const c = r.split(',');
          const asset = c[1]?.trim(), ticker = c[2]?.trim(), weight = c[3]?.trim();
          if (asset && weight) {
            table.innerHTML += `<tr><td><strong>${asset}</strong></td><td>${ticker}</td><td style="text-align:right;font-weight:700;">${weight}</td></tr>`;
            labels.push(asset);
            values.push(parseFloat(weight.replace('%', '')) || 0);
          }
        });

        if (pieChart) pieChart.destroy();
        pieChart = new Chart(document.getElementById('pieChart'), {
          type: 'doughnut',
          data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 4, borderColor: '#fff' }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
      } catch (e) {
        document.getElementById('compTable').innerHTML = '<tr><td colspan="3" style="text-align:center;padding:2rem;color:#94a3b8;">Composition en cours de mise à jour...</td></tr>';
      }
    }

    loadPortfolios();
  </script>
</body>
</html>
