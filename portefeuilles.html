<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nos Portefeuilles | AltInvest Capital</title>
  <link href="https://fonts.googleapis.com/css2?family=Satoshi:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--n:#0f172a;--g:#ca8a04;--sp:#64748b;--nas:#94a3b8;--l:#f8fafc;--gris:#94a3b8;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Satoshi',sans-serif;background:#fff;color:#1e293b;line-height:1.6;padding-top:90px;}
    nav{position:fixed;top:0;width:100%;background:var(--n);padding:1.5rem 0;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,0.3);}
    .nav{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 5rem;}
    .logo{font-size:2.4rem;font-weight:900;color:white;}.logo span{color:var(--g);}
    .links a{color:white;text-decoration:none;margin:0 2.5rem;font-weight:500;transition:.3s;}
    .links a:hover,.links a.active{color:var(--g);}
    .container{max-width:1400px;margin:0 auto;padding:120px 2rem;}
    h1{text-align:center;font-size:3.8rem;margin-bottom:5rem;color:var(--n);}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(520px,1fr));gap:4rem;}
    .card{background:white;border-radius:20px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,0.08);transition:.4s;cursor:pointer;}
    .card:hover{transform:translateY(-12px);box-shadow:0 35px 80px rgba(0,0,0,0.14);}
    .header{background:linear-gradient(135deg,var(--n),#1e3a8a);padding:3.5rem 2rem;text-align:center;color:white;}
    .header h3{font-size:2.4rem;font-weight:700;}
    .metrics{padding:3rem;display:grid;grid-template-columns:1fr 1fr;gap:1.8rem;}
    .kpi{background:var(--l);padding:1.8rem;border-radius:16px;text-align:center;}
    .kpi strong{font-size:2.8rem;display:block;color:var(--g);font-weight:700;}
    .kpi.red strong{color:#dc2626;}
    .kpi small{font-size:0.95rem;color:var(--gris);}

    /* Modal */
    #modal{display:none;position:fixed;inset:0;background:rgba(15,23,42,0.97);backdrop-filter:blur(12px);z-index:2000;align-items:center;justify-content:center;padding:2rem;overflow-y:auto;}
    #modal.active{display:flex;}
    .modal-content{background:white;border-radius:24px;max-width:1350px;width:95%;max-height:95vh;overflow-y:auto;box-shadow:0 40px 100px rgba(0,0,0,0.4);}
    .modal-header{background:var(--n);color:white;padding:2.5rem 3rem;display:flex;justify-content:space-between;align-items:center;border-radius:24px 24px 0 0;}
    .modal-header h2{font-size:2.6rem;font-weight:700;}
    .close{font-size:3.5rem;cursor:pointer;opacity:0.8;transition:.3s;}
    .close:hover{opacity:1;}
    .modal-body{padding:3rem 4rem 4rem;}

    .kpi-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:2.5rem;margin-bottom:4rem;}
    .kpi-big{background:var(--l);padding:2.2rem;border-radius:18px;text-align:center;border-left:6px solid var(--g);box-shadow:0 8px 25px rgba(0,0,0,0.06);}
    .kpi-big strong{font-size:3.4rem;color:var(--g);font-weight:800;}
    .kpi-big.red{border-left-color:#dc2626;}
    .kpi-big.red strong{color:#dc2626;}
    .kpi-big div{font-size:1.1rem;color:var(--gris);margin-top:0.5rem;}

    .chart-wrapper{position:relative;height:480px;max-height:70vh;margin:3rem 0;padding:1.5rem;background:white;border-radius:18px;box-shadow:0 15px 40px rgba(0,0,0,0.08);}
    .chart-wrapper canvas{position:absolute;top:0;left:0;width:100%!important;height:100%!important;}

    .metrics-tabs{text-align:center;margin:4rem 0 1rem;}
    .metrics-tabs select{padding:1rem 2rem;font-size:1.2rem;border-radius:12px;border:2px solid var(--gris);background:white;}

    table{width:100%;border-collapse:collapse;margin-top:3rem;}
    th,td{padding:1.2rem 0.5rem;border-bottom:1px solid #e2e8f0;text-align:left;}
    th{background:var(--l);font-weight:700;color:var(--n);}
    tr:last-child td{border:none;}
  </style>
</head>
<body>

<nav>
  <div class="nav">
    <div class="logo">AltInvest<span>.</span></div>
    <div class="links">
      <a href="index.html">Accueil</a>
      <a href="portefeuilles.html" class="active">Portefeuilles</a>
      <a href="devis.html">Devis</a>
      <a href="contact.html">Contact</a>
    </div>
  </div>
</nav>

<div class="container">
  <h1>Nos Portefeuilles</h1>
  <div class="grid" id="grid"></div>
</div>

<div id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title"></h2>
      <span class="close" onclick="closeModal()">x</span>
    </div>
    <div class="modal-body">
      <div class="kpi-bar" id="kpi-bar"></div>

      <div class="chart-wrapper"><canvas id="mainChart"></canvas></div>

      <div class="metrics-tabs">
        <select id="metricSelect" onchange="updateDetailChart()">
          <option value="vol">Volatilité annualisée</option>
          <option value="dd" selected>Drawdown</option>
        </select>
      </div>

      <div class="chart-wrapper"><canvas id="detailChart"></canvas></div>

      <h3 style="text-align:center;margin:4rem 0 1.5rem;font-size:2rem;">Composition actuelle</h3>
      <table><thead><tr><th>Actif</th><th>Ticker</th><th style="text-align:right;">Pondération</th></tr></thead><tbody id="comp"></tbody></table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const PORTFOLIOS = [
  { name: "Portefeuille Croissance", csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_portefeuille_croissance_v2.csv" },
  { name: "Portefeuille Défensif",   csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_portefeuille_defensif_v2.csv" },
  { name: "Portefeuille Europe",     csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_europe_v2.csv" }
];
const COMP_CSV = "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/composition_portefeuilles%20(3)%20(1).csv";

let currentData = [];
let mainChart = null;
let detailChart = null;

function closeModal() {
  document.getElementById('modal').classList.remove('active');
  document.body.style.overflow = '';
  if (mainChart) mainChart.destroy();
  if (detailChart) detailChart.destroy();
}

// CHARGEMENT DES VIGNETTES + YTD + PERF ANNUALIÉE
async function loadCards() {
  const grid = document.getElementById('grid');
  const currentYear = new Date().getFullYear();

  for (const p of PORTFOLIOS) {
    try {
      const txt = await fetch(p.csv).then(r => r.text());
      const lines = txt.trim().split('\n').slice(1);
      if (lines.length < 10) continue;

      const data = lines.map(l => {
        const v = l.split(',');
        return { date: v[0], port: +v[1], sp: +v[2], nas: +v[3], volM: +v[6] };
      });

      // Perf cumulée
      const perfCumul = data[data.length-1].port.toFixed(1);

      // YTD
      const ytdRow = data.find(d => d.date.startsWith(`${currentYear}-01-`)) || data[0];
      const perfYTD = ((data[data.length-1].port / ytdRow.port) - 1) * 100;
      const ytd = perfYTD.toFixed(1);

      // Perf annualisée (CAGR)
      const startDate = new Date(data[0].date);
      const endDate = new Date(data[data.length-1].date);
      const years = (endDate - startDate) / (1000 * 60 * 60 * 24 * 365.25);
      const totalReturn = data[data.length-1].port / 100;
      const perfAnn = (Math.pow(totalReturn + 1, 1/years) - 1) * 100;
      const annualisee = perfAnn.toFixed(1);

      // Volatilité annualisée (dernière valeur du CSV)
      const vol = data[data.length-1].volM.toFixed(1);

      // Drawdown max
      const dd = parseFloat(txt.trim().split('\n').pop().split(',')[8]).toFixed(1);

      // SHARPE RÉEL CALCULÉ
      const sharpe = vol > 0 ? (perfAnn / parseFloat(vol)).toFixed(2) : "N/A";

      grid.innerHTML += `
        <div class="card" onclick="openModal('${p.name}', '${p.csv}')">
          <div class="header"><h3>${p.name}</h3></div>
          <div class="metrics">
            <div class="kpi"><strong>${perfCumul}%</strong><small>Perf. cumulée</small></div>
            <div class="kpi"><strong>${ytd}%</strong><small>YTD ${currentYear}</small></div>
            <div class="kpi"><strong>${annualisee}%</strong><small>Perf. annualisée</small></div>
            <div class="kpi"><strong>${vol}%</strong><small>Vol. annualisée</small></div>
            <div class="kpi red"><strong>${dd}%</strong><small>Drawdown max</small></div>
            <div class="kpi"><strong>${sharpe}</strong><small>Ratio de Sharpe</small></div>
          </div>
        </div>`;
    } catch(e) { 
      console.error("Erreur chargement", p.name, e);
      grid.innerHTML += `<div class="error">Erreur ${p.name}</div>`;
    }
  }
}

async function openModal(name, url) {
  closeModal();
  document.getElementById('modal-title').textContent = name;
  document.getElementById('modal').classList.add('active');
  document.body.style.overflow = 'hidden';

  const txt = await fetch(url).then(r => r.text());
  const lines = txt.trim().split('\n').slice(1);
  currentData = lines.map(l => {
    const v = l.split(',');
    return { date: v[0], port: +v[1], sp: +v[2], nas: +v[3], volM: +v[6], ddC: +v[7], ddM: +v[8] };
  });

  const last = currentData[currentData.length-1];
  document.getElementById('kpi-bar').innerHTML = `
    <div class="kpi-big"><strong>${last.port.toFixed(1)}%</strong><div>Performance cumulée</div></div>
    <div class="kpi-big"><strong>${last.volM.toFixed(1)}%</strong><div>Volatilité annualisée</div></div>
    <div class="kpi-big red"><strong>${last.ddM.toFixed(1)}%</strong><div>Drawdown max</div></div>
    <div class="kpi-big"><strong>1.9</strong><div>Ratio de Sharpe</div></div>`;

  const comp = await fetch(COMP_CSV).then(r => r.text());
  document.getElementById('comp').innerHTML = comp.trim().split('\n').slice(1)
    .filter(r => r.startsWith(name))
    .map(r => { const [_,a,t,w] = r.split(','); return `<tr><td><strong>${a}</strong></td><td>${t}</td><td style="text-align:right;font-weight:700;">${w}</td></tr>`; })
    .join('');

  drawMainChart();
  updateDetailChart();
}

function drawMainChart() {
  if (mainChart) mainChart.destroy();
  mainChart = new Chart('mainChart', {
    type: 'line',
    data: {
      labels: currentData.map(d => d.date.slice(5)),
      datasets: [
        { label: 'Portefeuille', data: currentData.map(d => d.port), borderColor: '#ca8a04', backgroundColor: 'rgba(202,138,4,0.05)', borderWidth: 3, tension: 0.3, fill: true },
        { label: 'S&P 500', data: currentData.map(d => d.sp), borderColor: '#64748b', borderWidth: 2, tension: 0.3, borderDash: [6,6] },
        { label: 'NASDAQ', data: currentData.map(d => d.nas), borderColor: '#94a3b8', borderWidth: 2, tension: 0.3, borderDash: [10,6] }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { font: { size: 15 } } } } }
  });
}

function updateDetailChart() {
  if (detailChart) detailChart.destroy();
  const metric = document.getElementById('metricSelect').value;
  const labels = currentData.map(d => d.date.slice(5));

  if (metric === 'vol') {
    detailChart = new Chart('detailChart', {
      type: 'line',
      data: { labels, datasets: [{ label: 'Volatilité annualisée', data: currentData.map(d => d.volM), borderColor: '#ca8a04', backgroundColor: 'rgba(202,138,4,0.1)', fill: true, tension: 0.3 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Volatilité annualisée (%)', font: { size: 18 } } } }
    });
  } else {
    detailChart = new Chart('detailChart', {
      type: 'line',
      data: { labels, datasets: [
        { label: 'Drawdown actuel', data: currentData.map(d => d.ddC), borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.15)', fill: true },
        { label: 'Drawdown max', data: currentData.map(d => d.ddM), borderColor: '#7f1d1d', borderDash: [6,6] }
      ]},
      options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Drawdown (%)', font: { size: 18 } } } }
    });
  }
}

loadCards();
</script>
</body>
</html>
