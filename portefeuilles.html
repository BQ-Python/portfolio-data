<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nos Portefeuilles | AltInvest Capital</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    :root {
      --navy: #0f172a; --gold: #ca8a04; --gold-light: #f5d28a;
      --slate: #64748b; --light-slate: #94a3b8; --light: #f8fafc;
      --gray: #e2e8f0; --red: #dc2626; --green: #16a34a;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:#fff; color:#1e293b; line-height:1.6; padding-top:90px; }
    nav { position:fixed; top:0; left:0; right:0; background:var(--navy); padding:1.5rem 0; z-index:1000; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
    .nav { max-width:1400px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; padding:0 5rem; }
    .logo { font-size:2.4rem; font-weight:900; color:white; }
    .logo span { color:var(--gold); }
    .links a { color:white; text-decoration:none; margin:0 2rem; font-weight:500; transition:.3s; }
    .links a:hover, .links a.active { color:var(--gold); }

    .container { max-width:1400px; margin:0 auto; padding:120px 2rem 80px; }
    h1 { text-align:center; font-size:3.6rem; font-weight:800; margin-bottom:4rem;
         background:linear-gradient(90deg,var(--navy),var(--gold)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(460px,1fr)); gap:2.5rem; }
    .card { background:white; border-radius:24px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.08);
            transition:all .4s; cursor:pointer; }
    .card:hover { transform:translateY(-16px); box-shadow:0 30px 70px rgba(0,0,0,0.15); }
    .card-header { background:linear-gradient(135deg,var(--navy),#1e40af); padding:3rem 2rem; text-align:center; color:white; }
    .card-header h3 { font-size:2.2rem; font-weight:700; }
    .metrics { padding:2.5rem; display:grid; grid-template-columns:repeat(3,1fr); gap:1.5rem; }
    .kpi { text-align:center; padding:1.2rem; background:var(--light); border-radius:16px; }
    .kpi strong { display:block; font-size:2.2rem; font-weight:800; color:var(--gold); }
    .kpi.red strong { color:var(--red); }
    .kpi.green strong { color:var(--green); }
    .kpi small { font-size:0.9rem; color:var(--slate); margin-top:0.3rem; display:block; }

    #modal { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.97); backdrop-filter:blur(16px);
             z-index:2000; align-items:center; justify-content:center; padding:2rem; overflow-y:auto; }
    #modal.active { display:flex; }
    .modal-content { background:white; border-radius:28px; max-width:1400px; width:95%; max-height:95vh; overflow:hidden;
                     box-shadow:0 40px 100px rgba(0,0,0,0.5); }
    .modal-header { background:var(--navy); color:white; padding:2rem 3rem; display:flex; justify-content:space-between; align-items:center; }
    .modal-header h2 { font-size:2.4rem; font-weight:800; }
    .close { font-size:3rem; cursor:pointer; opacity:0.8; transition:.3s; }
    .close:hover { opacity:1; transform:rotate(90deg); }
    .modal-body { padding:3rem 4rem 4rem; }

    .kpi-bar { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1.5rem; margin-bottom:3rem; }
    .kpi-big { background:var(--light); padding:1.8rem; border-radius:18px; text-align:center;
               border-left:6px solid var(--gold); transition:all .3s; }
    .kpi-big:hover { transform:translateY(-6px); box-shadow:0 15px 30px rgba(0,0,0,0.1); }
    .kpi-big.red { border-left-color:var(--red); }
    .kpi-big.red strong { color:var(--red); }
    .kpi-big strong { font-size:2.6rem; font-weight:800; color:var(--gold); display:block; }
    .kpi-big div { font-size:1rem; color:var(--slate); margin-top:0.5rem; }

    .chart-container { position:relative; height:480px; margin:3rem 0; background:white; border-radius:20px;
                       padding:1.5rem; box-shadow:0 10px 40px rgba(0,0,0,0.07); }
    .date-range { display:flex; justify-content:center; gap:1.5rem; margin:2rem 0; flex-wrap:wrap; align-items:center; }
    .date-range input, .date-range button { padding:0.8rem 1.4rem; border:2px solid var(--gray); border-radius:12px; font-size:1rem; }
    .date-range button { border:none; background:var(--gold); color:white; cursor:pointer; font-weight:600; transition:0.3s; }
    .date-range button:hover { background:#b37a00; }

    .comp-grid { display:grid; grid-template-columns:1fr 1fr; gap:3rem; margin-top:3rem; align-items:center; }
    @media (max-width:992px) { .comp-grid { grid-template-columns:1fr; } }
  </style>
</head>
<body>

<nav>
  <div class="nav">
    <div class="logo">AltInvest<span>.</span></div>
    <div class="links">
      <a href="index.html">Accueil</a>
      <a href="portefeuilles.html" class="active">Portefeuilles</a>
      <a href="devis.html">Devis</a>
      <a href="contact.html">Contact</a>
    </div>
  </div>
</nav>

<div class="container">
  <h1>Nos Portefeuilles d'Investissement</h1>
  <div class="grid" id="grid"></div>
</div>

<div id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title"></h2>
      <span class="close" onclick="closeModal()">×</span>
    </div>
    <div class="modal-body">

      <div class="kpi-bar" id="kpi-bar"></div>

      <div class="date-range">
        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button onclick="applyDateFilter()">Appliquer le filtre</button>
        <button onclick="resetDateFilter()" style="background:#64748b;">Tout afficher</button>
      </div>

      <div class="chart-container"><canvas id="mainChart"></canvas></div>

      <div style="text-align:center;margin:2rem 0;">
        <select id="metricSelect" onchange="updateDetailChart()" style="padding:1rem 2rem;font-size:1.1rem;border-radius:12px;border:2px solid #cbd5e1;">
          <option value="dd">Drawdown</option>
          <option value="vol">Volatilité</option>
        </select>
      </div>
      <div class="chart-container"><canvas id="detailChart"></canvas></div>

      <h3 style="text-align:center;margin:4rem 0 2rem;font-size:2rem;font-weight:700;">Composition Actuelle</h3>
      <div class="comp-grid">
        <div class="chart-container" style="height:400px;"><canvas id="pieChart"></canvas></div>
        <div>
          <table><thead><tr><th>Actif</th><th>Ticker</th><th style="text-align:right;">Pondération</th></tr></thead>
                 <tbody id="compTable"></tbody></table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const PORTFOLIOS = [
  { name: "Portefeuille Croissance", csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_portefeuille_croissance_v2.csv" },
  { name: "Portefeuille Défensif",   csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_portefeuille_defensif_v2.csv" },
  { name: "Portefeuille Europe",     csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_europe_v2.csv" }
];
const COMP_CSV = "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/composition_portefeuilles%20(3).csv";

let rawData = [], filteredData = [];
let mainChart = null, detailChart = null, pieChart = null;
let currentPortfolioName = "";

// === Calculs avancés ===
function dailyReturns(values) {
  const rets = [];
  for (let i = 1; i < values.length; i++) {
    rets.push(values[i] / values[i-1] - 1);
  }
  return rets;
}

function calculateAdvancedMetrics(portRets, benchRets) {
  if (portRets.length < 10) return { alpha: "N/A", beta: "N/A", te: "N/A", ir: "N/A", r2: "N/A" };
  const n = portRets.length;
  const meanP = portRets.reduce((a,b)=>a+b,0)/n;
  const meanB = benchRets.reduce((a,b)=>a+b,0)/n;

  let cov = 0, varB = 0;
  for (let i = 0; i < n; i++) {
    cov += (portRets[i] - meanP) * (benchRets[i] - meanB);
    varB += (benchRets[i] - meanB) ** 2;
  }
  const beta = varB > 0 ? cov / varB : 0;
  const alphaDaily = meanP - beta * meanB;
  const alphaAnn = (Math.pow(1 + alphaDaily, 252) - 1) * 100;

  let teSquared = 0;
  for (let i = 0; i < n; i++) {
    const active = portRets[i] - (alphaDaily + beta * benchRets[i]);
    teSquared += active * active;
  }
  const teAnn = Math.sqrt(teSquared / n) * Math.sqrt(252) * 100;
  const ir = teAnn > 0 ? alphaAnn / teAnn : 0;

  const r2 = 1 - (teSquared / portRets.reduce((s,v)=>s+(v-meanP)**2, 0));

  return {
    alpha: alphaAnn.toFixed(2),
    beta: beta.toFixed(2),
    te: teAnn.toFixed(2),
    ir: ir.toFixed(2),
    r2: (r2 * 100).toFixed(1)
  };
}

function closeModal() {
  document.getElementById('modal').classList.remove('active');
  document.body.style.overflow = '';
  [mainChart, detailChart, pieChart].forEach(c => c?.destroy());
}

async function loadCards() {
  const grid = document.getElementById('grid');
  for (const p of PORTFOLIOS) {
    try {
      const text = await fetch(p.csv).then(r => r.text());
      const lines = text.trim().split('\n').slice(1);
      const data = lines.map(l => {
        const [date, port, sp, nas, , , volM, , ddM] = l.split(',');
        return { date, port: +port, sp: +sp, volM: +volM, ddM: +ddM };
      });
      const last = data[data.length - 1];
      const card = document.createElement('div');
      card.className = 'card';
      card.onclick = () => openModal(p.name, p.csv);
      card.innerHTML = `
        <div class="card-header"><h3>${p.name}</h3></div>
        <div class="metrics">
          <div class="kpi"><strong>${last.port.toFixed(1)}%</strong><small>Perf. cumulée</small></div>
          <div class="kpi"><strong>${last.volM.toFixed(1)}%</strong><small>Volatilité</small></div>
          <div class="kpi red"><strong>${last.ddM.toFixed(1)}%</strong><small>Drawdown max</small></div>
        </div>`;
      grid.appendChild(card);
    } catch (e) { console.error(e); }
  }
}

async function openModal(name, url) {
  closeModal();
  currentPortfolioName = name;
  document.getElementById('modal-title').textContent = name;
  document.getElementById('modal').classList.add('active');
  document.body.style.overflow = 'hidden';

  const text = await fetch(url).then(r => r.text());
  const lines = text.trim().split('\n').slice(1);
  rawData = lines.map(l => {
    const [date, port, sp, nas, , , volM, ddC, ddM] = l.split(',');
    return { date, port: +port, sp: +sp, nas: +nas, volM: +volM, ddC: +ddC, ddM: +ddM };
  }).filter(d => d.date && !isNaN(d.port));

  filteredData = [...rawData];
  setupDateInputs();
  updateAll();
  await loadComposition(name);
}

function setupDateInputs() {
  const dates = rawData.map(d => d.date).sort();
  const minDate = dates[0];
  const maxDate = dates[dates.length - 1];
  const startInput = document.getElementById('startDate');
  const endInput = document.getElementById('endDate');
  startInput.value = minDate;
  startInput.min = minDate;
  startInput.max = maxDate;
  endInput.value = maxDate;
  endInput.min = minDate;
  endInput.max = maxDate;
}

function applyDateFilter() {
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  if (!start || !end) return;
  filteredData = rawData.filter(d => d.date >= start && d.date <= end);
  if (filteredData.length < 2) {
    alert("Période trop courte — minimum 2 points requis");
    return;
  }
  updateAll();
}

function resetDateFilter() {
  filteredData = [...rawData];
  setupDateInputs();
  updateAll();
}

function updateAll() {
  updateKPIs();
  drawMainChart();
  updateDetailChart();
}

function updateKPIs() {
  if (filteredData.length < 2) return;

  const last = filteredData[filteredData.length - 1];
  const first = filteredData[0];
  const year = new Date().getFullYear();
  const firstThisYear = filteredData.find(d => d.date.startsWith(year + '-01')) || first;
  const ytd = ((last.port / firstThisYear.port) - 1) * 100;

  const days = (new Date(last.date) - new Date(first.date)) / (1000 * 3600 * 24);
  const years = days / 365.25;
  const cagr = years > 0 ? (Math.pow(last.port / 100 + 1, 1 / years) - 1) * 100 : 0;
  const sharpe = last.volM > 0 ? (cagr / last.volM).toFixed(2) : 'N/A';

  const portVals = filteredData.map(d => d.port / 100 + 1);
  const benchVals = filteredData.map(d => d.sp / 100 + 1);
  const portRets = dailyReturns(portVals);
  const benchRets = dailyReturns(benchVals);
  const adv = calculateAdvancedMetrics(portRets, benchRets);

  document.getElementById('kpi-bar').innerHTML = `
    <div class="kpi-big"><strong>${last.port.toFixed(1)}%</strong><div>Performance cumulée</div></div>
    <div class="kpi-big"><strong class="${ytd>=0?'':'red'}">${ytd.toFixed(1)}%</strong><div>YTD ${year}</div></div>
    <div class="kpi-big"><strong>${cagr.toFixed(1)}%</strong><div>Perf. annualisée</div></div>
    <div class="kpi-big"><strong>${last.volM.toFixed(1)}%</strong><div>Volatilité</div></div>
    <div class="kpi-big red"><strong>${last.ddM.toFixed(1)}%</strong><div>Drawdown max</div></div>
    <div class="kpi-big"><strong>${sharpe}</strong><div>Ratio de Sharpe</div></div>

    <div class="kpi-big"><strong>${adv.alpha}%</strong><div>Alpha annualisé</div></div>
    <div class="kpi-big"><strong>${adv.beta}</strong><div>Bêta (vs S&P 500)</div></div>
    <div class="kpi-big"><strong>${adv.te}%</strong><div>Tracking Error</div></div>
    <div class="kpi-big"><strong>${adv.ir}</strong><div>Information Ratio</div></div>
    <div class="kpi-big"><strong>${adv.r2}%</strong><div>R²</div></div>
  `;
}

function drawMainChart() {
  if (mainChart) mainChart.destroy();
  mainChart = new Chart(document.getElementById('mainChart'), {
    type: 'line',
    data: {
      labels: filteredData.map(d => d.date),
      datasets: [
        { label: currentPortfolioName, data: filteredData.map(d => d.port), borderColor: '#ca8a04', backgroundColor: 'rgba(202,138,4,0.07)', fill: true, tension: 0.4, borderWidth: 4 },
        { label: 'S&P 500', data: filteredData.map(d => d.sp), borderColor: 'rgba(100,116,139,0.6)', borderWidth: 2.5, tension: 0.4, borderDash: [10,8] },
        { label: 'NASDAQ 100', data: filteredData.map(d => d.nas), borderColor: 'rgba(148,163,184,0.5)', borderWidth: 2, tension: 0.4, borderDash: [15,10] }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { font: { size: 15, weight: '600' }, color: '#1e293b' } },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%` } },
        zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } }
      },
      scales: {
        x: { type: 'time', time: { unit: 'month', displayFormats: { month: 'MMM YYYY' } }, grid: { display: false } },
        y: { grid: { color: '#f1f5f9' }, ticks: { callback: v => v + '%' } }
      }
    }
  });
}

function updateDetailChart() {
  if (detailChart) detailChart.destroy();
  const metric = document.getElementById('metricSelect').value;
  const data = metric === 'vol' ? filteredData.map(d => d.volM) : filteredData.map(d => d.ddC);
  const title = metric === 'vol' ? 'Volatilité annualisée (%)' : 'Drawdown actuel (%)';
  const color = metric === 'vol' ? '#ca8a04' : '#dc2626';

  detailChart = new Chart(document.getElementById('detailChart'), {
    type: 'line',
    data: { labels: filteredData.map(d => d.date), datasets: [{ label: title, data, borderColor: color, backgroundColor: color + '22', fill: true, tension: 0.3 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: title, font: { size: 18 } } }, scales: { x: { type: 'time', time: { unit: 'month' } } } }
  });
}

async function loadComposition(name) {
  try {
    const text = await fetch(COMP_CSV).then(r => r.text());
    const rows = text.trim().split('\n').slice(1);
    const relevant = rows.filter(r => r.split(',')[0].trim() === name);

    const table = document.getElementById('compTable');
    table.innerHTML = '';
    const labels = [], values = [];
    const colors = ['#ca8a04','#e4b94c','#f5d28a','#ca8a04','#b37a00','#8c6200','#6b4d00','#4a3700'];

    relevant.forEach(row => {
      const [_, asset, ticker, weight] = row.split(',');
      const w = parseFloat(weight.replace('%','').trim());
      table.innerHTML += `<tr><td><strong>${asset.trim()}</strong></td><td>${ticker.trim()}</td><td style="text-align:right;font-weight:700;">${weight}</td></tr>`;
      labels.push(asset.trim());
      values.push(w);
    });

    if (pieChart) pieChart.destroy();
    pieChart = new Chart(document.getElementById('pieChart'), {
      type: 'doughnut',
      data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 4, borderColor: '#fff' }] },
      options: { responsive: true, plugins: { legend: { position: 'right', labels: { padding: 20 } } } }
    });
  } catch (e) { console.error("Composition non chargée", e); }
}

loadCards();
</script>
</body>
</html>
