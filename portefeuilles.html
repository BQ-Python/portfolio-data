<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horizon Labs - Portefeuilles</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    :root {
      --bg: #040512;
      --accent: #4a90e2;
      --muted: rgba(255,255,255,0.78);
      --card-bg: rgba(255,255,255,0.03);
      --card-strong: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.08);
      --red: #dc2626;
      --green: #16a34a;
      --orange: #ea580c;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: #fff; padding-top: 90px; line-height: 1.6; -webkit-font-smoothing: antialiased; }

    /* NAVIGATION */
    nav { position: fixed; top: 16px; left: 0; right: 0; z-index: 1200; display: flex; justify-content: center; }
    .nav { width: 1280px; max-width: 96%; display: flex; justify-content: space-between; align-items: center; padding: 10px 18px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); backdrop-filter: blur(12px); border-radius: 8px; border: 1px solid var(--border); }
    .logo { font-size: 1.3rem; font-weight: 800; }
    .logo span { color: var(--accent); }
    .links { display: flex; align-items: center; gap: 24px; }
    .links a { color: var(--muted); text-decoration: none; font-weight: 500; transition: all .25s; }
    .links a:hover, .links a.active { color: #fff; }
    .auth-button { background: var(--accent); color: #fff; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.95rem; }
    #user-menu { display: none; align-items: center; gap: 12px; }
    #user-photo { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); }
    #user-name { font-weight: 600; }
    #logout-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.9rem; }
    #logout-btn:hover { color: #fff; }

    #login-btn, #user-menu { visibility: hidden; }
    body.firebase-ready #login-btn, body.firebase-ready #user-menu { visibility: visible; }

    .container { max-width: 1400px; margin: 0 auto; padding: 120px 2rem 80px; text-align: center; }
    h1 { font-size: clamp(2rem,4.5vw,3.4rem); line-height: 1.05; font-weight: 800; margin-bottom: 4rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(460px, 1fr)); gap: 2.5rem; margin-top: 3rem; }
    .card { background: linear-gradient(180deg, var(--card-bg), var(--card-strong)); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); box-shadow: 0 6px 18px rgba(0,0,0,0.35); transition: all .4s; cursor: pointer; }
    .card:hover { transform: translateY(-16px); box-shadow: 0 30px 70px rgba(0,0,0,0.35); }
    .card-header { background: linear-gradient(135deg, #02030a, #040512); padding: 3rem 2rem; color: #fff; text-align: center; }
    .card-header h3 { font-size: 2.2rem; font-weight: 700; }
    .metrics { padding: 2.5rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.2rem; }
    .kpi { text-align: center; padding: 1rem; background: var(--card-bg); border-radius: 14px; border: 1px solid var(--border); }
    .kpi strong { display: block; font-size: 2rem; font-weight: 800; color: var(--accent); }
    .kpi.red strong { color: var(--red); }
    .kpi.green strong { color: var(--green); }
    .kpi small { font-size: 0.85rem; color: var(--muted); display: block; margin-top: 4px; }

    #modal { display: none; position: fixed; inset: 0; background: rgba(4,5,18,0.97); backdrop-filter: blur(16px); z-index: 2000; align-items: center; justify-content: center; padding: 2rem; overflow-y: auto; }
    #modal.active { display: flex; }
    .modal-content { background: linear-gradient(180deg, var(--card-bg), var(--card-strong)); border-radius: 28px; max-width: 1400px; width: 95%; max-height: 95vh; overflow-y: auto; box-shadow: 0 40px 100px rgba(0,0,0,0.5); border: 1px solid var(--border); }
    .modal-header { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color: #fff; padding: 2rem 3rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    .modal-header h2 { font-size: 2.4rem; font-weight: 800; }
    .close { font-size: 3rem; cursor: pointer; opacity: 0.8; transition: .3s; color: var(--muted); }
    .close:hover { opacity: 1; transform: rotate(90deg); }
    .modal-body { padding: 3rem 4rem 4rem; color: var(--muted); }
    .kpi-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
    .kpi-big { background: var(--card-bg); padding: 1.8rem; border-radius: 18px; text-align: center; border-left: 6px solid var(--accent); border: 1px solid var(--border); }
    .kpi-big.red { border-left-color: var(--red); }
    .kpi-big.red strong { color: var(--red); }
    .kpi-big strong { font-size: 2.5rem; font-weight: 800; color: var(--accent); display: block; }
    .kpi-big div { font-size: 0.95rem; color: var(--muted); margin-top: 6px; }
    .chart-wrapper { position: relative; height: 420px; background: var(--card-bg); border-radius: 20px; padding: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.35); margin: 3rem 0; border: 1px solid var(--border); }
    .chart-controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 15px; }
    .chart-btn { padding: 9px 16px; border: none; border-radius: 10px; background: var(--card-bg); color: var(--muted); font-size: 0.95rem; cursor: pointer; transition: .2s; font-weight: 600; border: 1px solid var(--border); }
    .chart-btn.active, .chart-btn:hover { background: var(--accent); color: #fff; }
    .comp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; margin-top: 3rem; align-items: start; }
    @media (max-width: 992px) { .comp-grid { grid-template-columns: 1fr; } }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.9rem; text-align: left; border-bottom: 1px solid var(--border); color: #fff; }
    th { background: var(--card-strong); font-weight: 600; color: #fff; }
  </style>
</head>
<body>

  <nav>
    <div class="nav">
      <div class="logo">Horizon<span>Labs</span></div>
      <div class="links">
        <a href="index.html">Accueil</a>
        <a href="portefeuilles.html" class="active">Portefeuilles</a>
        <a href="newsletter.html">Newsletter</a>
        <a href="abonnements.html">Abonnements</a>
        <a href="auth.html" id="login-btn" class="auth-button">S'authentifier</a>
        <div id="user-menu">
          <img id="user-photo" src="" alt="Photo">
          <span id="user-name"></span>
          <button id="logout-btn">Déconnexion</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1>Nos Portefeuilles d'Investissement</h1>
    <div class="grid" id="grid"></div>
  </div>

  <div id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title"></h2>
        <span class="close" onclick="closeModal()">×</span>
      </div>
      <div class="modal-body">
        <div class="kpi-bar" id="kpi-bar"></div>
        <div class="chart-wrapper"><div class="chart-controls" id="mainControls"></div><canvas id="mainChart"></canvas></div>
        <div class="chart-wrapper"><div class="chart-controls" id="detailControls"></div><canvas id="detailChart"></canvas></div>
        <div class="chart-wrapper">
          <div style="text-align:center; margin-bottom:12px;">
            <h3 style="font-size:1.65rem; font-weight:700; color:#fff;">Value at Risk (VaR) Historique – 30 jours glissants</h3>
          </div>
          <div class="chart-controls" id="varControls"></div>
          <canvas id="varChart"></canvas>
        </div>
        <h3 style="text-align:center;margin:4rem 0 2rem;font-size:2rem;font-weight:700;">Composition Actuelle</h3>
        <div class="comp-grid">
          <div class="chart-wrapper" style="height:350px;"><canvas id="pieChart"></canvas></div>
          <table><thead><tr><th>Actif</th><th>Ticker</th><th style="text-align:right;">Pondération</th></tr></thead><tbody id="compTable"></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Auth -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB7sRyQt1lNuXqpcesTvL6ktpCAurTcIdk",
      authDomain: "horizon-labs-3321a.firebaseapp.com",
      projectId: "horizon-labs-3321a",
      storageBucket: "horizon-labs-3321a.firebasestorage.app",
      messagingSenderId: "28359753916",
      appId: "1:28359753916:web:bf23bece9f6d1c094090b9",
      measurementId: "G-QJLJM4M3Z8"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    document.body.classList.add('firebase-ready');

    auth.onAuthStateChanged(user => {
      const loginBtn = document.getElementById('login-btn');
      const userMenu = document.getElementById('user-menu');
      if (user) {
        loginBtn.style.display = 'none';
        userMenu.style.display = 'flex';
        document.getElementById('user-name').textContent = user.displayName?.split(' ')[0] || 'Membre';
        document.getElementById('user-photo').src = user.photoURL || 'https://via.placeholder.com/36/4a90e2/ffffff?text=H';
      } else {
        loginBtn.style.display = 'block';
        userMenu.style.display = 'none';
      }
    });
    document.getElementById('logout-btn').addEventListener('click', () => auth.signOut().then(() => location.reload()));
  </script>

  <!-- SCRIPT PRINCIPAL COMPLET -->
  <script>
    const BASE_URL = "https://raw.githubusercontent.com/BQ-Python/portfolio-data/main/";
    const PORTFOLIOS_JSON = BASE_URL + "portfolios.json";
    const COMP_CSV = BASE_URL + "composition_portefeuilles.csv";

    let PORTFOLIOS = [];
    let rawData = [], mainChart = null, detailChart = null, varChart = null, pieChart = null;
    let currentPortfolioName = "";

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      document.body.style.overflow = '';
      [mainChart, detailChart, varChart, pieChart].forEach(c => c?.destroy());
    }

    function parseLine(line) {
      const cols = line.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
      if (cols.length < 19) return null;
      const dateStr = cols[0];
      if (!dateStr) return null;
      const date = new Date(dateStr);
      if (isNaN(date)) return null;

      return {
        date,
        port100: parseFloat(cols[1]) || 100,
        sp100: parseFloat(cols[2]) || 100,
        nas100: parseFloat(cols[3]) || 100,
        volM: parseFloat(cols[6]) || 0,
        ddC: parseFloat(cols[7]) || 0,
        ddM: parseFloat(cols[8]) || 0,
        dailyRet: (parseFloat(cols[9]) || 0) / 100,
        sharpe: parseFloat(cols[18]) || 0
      };
    }

    async function loadPortfolios() {
      try {
        const res = await fetch(PORTFOLIOS_JSON + '?t=' + Date.now());
        PORTFOLIOS = await res.json();
        PORTFOLIOS = PORTFOLIOS.map(p => ({ ...p, csv: BASE_URL + p.file }));
        await loadCards();
      } catch (e) {
        document.getElementById('grid').innerHTML = '<p style="color:var(--red);grid-column:1/-1;text-align:center;">Erreur de chargement des portefeuilles.</p>';
      }
    }

    async function loadCards() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--muted);">Chargement des performances...</p>';
      const currentYear = new Date().getFullYear();

      for (const p of PORTFOLIOS) {
        try {
          const text = await fetch(p.csv + '?t=' + Date.now()).then(r => r.text());
          const lines = text.trim().split('\n');
          if (lines.length < 2) continue;
          const data = lines.slice(1).map(parseLine).filter(Boolean);
          if (data.length === 0) continue;

          const last = data[data.length - 1];
          const first = data[0];
          const firstYTD = data.find(d => d.date.getFullYear() === currentYear) || first;

          const ytd = ((last.port100 / firstYTD.port100) - 1) * 100;
          const years = (last.date - first.date) / (1000 * 60 * 60 * 24 * 365.25);
          const cagr = years > 0 ? (Math.pow(last.port100 / 100, 1 / years) - 1) * 100 : 0;
          const avgSharpe = data.reduce((s, d) => s + (d.sharpe || 0), 0) / data.length;

          const card = document.createElement('div');
          card.className = 'card';
          card.onclick = () => openModal(p.name, p.csv);
          card.innerHTML = `
            <div class="card-header"><h3>${p.name}</h3></div>
            <div class="metrics">
              <div class="kpi"><strong>${(last.port100 - 100).toFixed(1)}%</strong><small>Perf. cumulée</small></div>
              <div class="kpi ${ytd >= 0 ? 'green' : 'red'}"><strong>${ytd.toFixed(1)}%</strong><small>YTD ${currentYear}</small></div>
              <div class="kpi"><strong>${cagr.toFixed(1)}%</strong><small>CAGR</small></div>
              <div class="kpi"><strong>${last.volM.toFixed(1)}%</strong><small>Vol 21j</small></div>
              <div class="kpi red"><strong>${last.ddM.toFixed(1)}%</strong><small>Max DD</small></div>
              <div class="kpi"><strong>${avgSharpe.toFixed(2)}</strong><small>Sharpe</small></div>
            </div>`;
          grid.appendChild(card);
        } catch (e) {
          console.error("Erreur carte", p.name, e);
        }
      }
      if (!grid.querySelector('.card')) {
        grid.innerHTML = '<p style="color:var(--red);grid-column:1/-1;text-align:center;">Aucun portefeuille disponible pour le moment.</p>';
      }
    }

    async function openModal(name, url) {
      closeModal();
      currentPortfolioName = name;
      document.getElementById('modal-title').textContent = name;
      document.getElementById('modal').classList.add('active');
      document.body.style.overflow = 'hidden';

      try {
        const text = await fetch(url + '?t=' + Date.now()).then(r => r.text());
        rawData = text.trim().split('\n').slice(1).map(parseLine).filter(Boolean);
        updateKPIs();
        drawMainChart();
        drawDetailChart();
        drawVaRChart();
        await loadComposition(name);
      } catch (e) {
        console.error("Erreur ouverture modal", e);
      }
    }

    function updateKPIs() {
      const last = rawData[rawData.length - 1];
      const first = rawData[0];
      const currentYear = new Date().getFullYear();
      const firstYTD = rawData.find(d => d.date.getFullYear() === currentYear) || first;

      const ytd = ((last.port100 / firstYTD.port100) - 1) * 100;
      const years = (last.date - first.date) / (1000 * 60 * 60 * 24 * 365.25);
      const cagr = years > 0 ? (Math.pow(last.port100 / 100, 1 / years) - 1) * 100 : 0;
      const avgSharpe = rawData.reduce((s, d) => s + (d.sharpe || 0), 0) / rawData.length;

      document.getElementById('kpi-bar').innerHTML = `
        <div class="kpi-big"><strong>${(last.port100 - 100).toFixed(1)}%</strong><div>Performance cumulée</div></div>
        <div class="kpi-big ${ytd >= 0 ? '' : 'red'}"><strong>${ytd.toFixed(1)}%</strong><div>YTD ${currentYear}</div></div>
        <div class="kpi-big"><strong>${cagr.toFixed(1)}%</strong><div>CAGR</div></div>
        <div class="kpi-big"><strong>${last.volM.toFixed(1)}%</strong><div>Volatilité (21j)</div></div>
        <div class="kpi-big red"><strong>${last.ddM.toFixed(1)}%</strong><div>Drawdown max</div></div>
        <div class="kpi-big"><strong>${avgSharpe.toFixed(2)}</strong><div>Sharpe moyen</div></div>`;
    }

    function createButtons(containerId, chartInstance) {
      const div = document.getElementById(containerId);
      div.innerHTML = '';
      ['1M', '3M', '6M', 'YTD', '1A', '3A', 'Tout'].forEach((label, i) => {
        const btn = document.createElement('button');
        btn.className = 'chart-btn' + (i === 6 ? ' active' : '');
        btn.textContent = label;
        btn.onclick = () => {
          div.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          if (label === 'Tout') chartInstance.resetZoom();
          else if (label === 'YTD') chartInstance.zoomScale('x', { min: new Date(`${new Date().getFullYear()}-01-01`).getTime(), max: Date.now() });
          else {
            const days = { '1M': 30, '3M': 90, '6M': 180, '1A': 365, '3A': 1095 }[label];
            chartInstance.zoomScale('x', { min: Date.now() - days * 86400000, max: Date.now() });
          }
        };
        div.appendChild(btn);
      });
    }

    function drawMainChart() {
      if (mainChart) mainChart.destroy();
      const values = [...rawData.map(d => d.port100 - 100), ...rawData.map(d => d.sp100 - 100), ...rawData.map(d => d.nas100 - 100)];
      const minVal = Math.min(...values);
      const maxVal = Math.max(...values);
      const range = Math.max(maxVal - minVal, 30);
      const yMin = Math.floor(minVal - range * 0.15);
      const yMax = Math.ceil(maxVal + range * 0.10);

      mainChart = new Chart(document.getElementById('mainChart'), {
        type: 'line',
        data: {
          labels: rawData.map(d => d.date),
          datasets: [
            { label: currentPortfolioName, data: rawData.map(d => d.port100 - 100), borderColor: '#4a90e2', backgroundColor: 'rgba(74,144,226,0.08)', fill: true, tension: 0.38, borderWidth: 4.5, pointRadius: 0 },
            { label: 'S&P 500', data: rawData.map(d => d.sp100 - 100), borderColor: 'rgba(255,255,255,0.5)', borderWidth: 2.8, borderDash: [10, 7], tension: 0.38, pointRadius: 0 },
            { label: 'NASDAQ 100', data: rawData.map(d => d.nas100 - 100), borderColor: 'rgba(255,255,255,0.3)', borderWidth: 2.5, borderDash: [14, 9], tension: 0.38, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top', labels: { font: { size: 14, weight: 600 }, color: '#fff' } },
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%` }, backgroundColor: 'rgba(4,5,18,0.9)' },
            zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } }
          },
          scales: {
            x: { type: 'time', time: { unit: 'month', displayFormats: { month: 'MMM yyyy' } }, grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.7)' } },
            y: { min: yMin, max: yMax, ticks: { callback: v => v + '%', color: 'rgba(255,255,255,0.7)' }, grid: { color: 'rgba(255,255,255,0.06)' } }
          }
        }
      });
      createButtons('mainControls', mainChart);
    }

    function drawDetailChart() {
      if (detailChart) detailChart.destroy();
      detailChart = new Chart(document.getElementById('detailChart'), {
        type: 'line',
        data: {
          labels: rawData.map(d => d.date),
          datasets: [
            { label: 'Volatilité annualisée (21j)', data: rawData.map(d => d.volM), borderColor: '#4a90e2', backgroundColor: 'rgba(74,144,226,0.15)', fill: true, tension: 0.4 },
            { label: 'Drawdown actuel', data: rawData.map(d => d.ddC), borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.15)', fill: true, tension: 0.4 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top', labels: { color: '#fff' } }, title: { display: true, text: 'Risque : Volatilité & Drawdown', font: { size: 16 }, color: '#fff' } },
          scales: { x: { type: 'time', ticks: { color: 'rgba(255,255,255,0.7)' } }, y: { ticks: { callback: v => v + '%', color: 'rgba(255,255,255,0.7)' } } }
        }
      });
      createButtons('detailControls', detailChart);
    }

    function drawVaRChart() {
      if (varChart) varChart.destroy();
      const returns = rawData.map(d => d.dailyRet);
      const var95 = [], var99 = [];
      for (let i = 29; i < returns.length; i++) {
        const window = returns.slice(i - 29, i + 1);
        const sorted = window.slice().sort((a, b) => a - b);
        var95.push(sorted[Math.floor(0.05 * sorted.length)] * 100);
        var99.push(sorted[Math.floor(0.01 * sorted.length)] * 100);
      }
      const labels = rawData.slice(29).map(d => d.date);
      const all = [...var95, ...var99];
      const minV = Math.min(...all);
      const maxV = Math.max(...all);
      const rangeV = maxV - minV || 10;
      const yMin = Math.floor(minV - rangeV * 0.2);
      const yMax = Math.ceil(maxV + rangeV * 0.1);

      varChart = new Chart(document.getElementById('varChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'VaR 95% (30j)', data: var95, borderColor: '#ea580c', backgroundColor: 'rgba(234,88,12,0.12)', fill: true, tension: 0.4, borderWidth: 3.5 },
            { label: 'VaR 99% (30j)', data: var99, borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,0.12)', fill: true, tension: 0.4, borderWidth: 3.5 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top', labels: { color: '#fff' } },
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%` }, backgroundColor: 'rgba(4,5,18,0.9)' }
          },
          scales: {
            x: { type: 'time', time: { unit: 'month' }, ticks: { color: 'rgba(255,255,255,0.7)' } },
            y: { min: yMin, max: yMax > 0 ? yMax : 0, ticks: { callback: v => v.toFixed(1) + '%', color: 'rgba(255,255,255,0.7)' } }
          }
        }
      });
      createButtons('varControls', varChart);
    }

    async function loadComposition(name) {
      try {
        const text = await fetch(COMP_CSV + '?t=' + Date.now()).then(r => r.text());
        const lines = text.trim().split('\n');
        const header = lines[0].split(',').map(h => h.trim());
        const rows = lines.slice(1);

        const pfIdx = header.indexOf('Portefeuille');
        const actifIdx = header.indexOf('Actif');
        const tickerIdx = header.indexOf('Ticker');
        const poidsIdx = header.indexOf('Pondération');

        const relevant = rows
          .map(r => r.split(',').map(c => c.trim().replace(/^"|"$/g, '')))
          .filter(cols => cols[pfIdx] === name);

        const table = document.getElementById('compTable');
        table.innerHTML = '';
        const labels = [], values = [];
        const colors = ['#4a90e2','#6aa9f2','#8ac3ff','#2a76c8','#0a5cae','#004494','#00d4ff','#00a1c7','#ff6b6b','#ff8787','#66bb6a','#81c784','#ff5252','#43a047','#c92a2a','#2e7d32','#ff1744','#8b1a1a','#007bff','#0066cc'];

        relevant.forEach((cols, i) => {
          const actif = cols[actifIdx] || 'Inconnu';
          const ticker = cols[tickerIdx] || '';
          const poids = cols[poidsIdx] || '0%';
          table.innerHTML += `<tr><td><strong>${actif}</strong></td><td>${ticker}</td><td style="text-align:right;font-weight:700;">${poids}</td></tr>`;
          labels.push(actif);
          values.push(parseFloat(poids.replace('%', '')) || 0);
        });

        if (pieChart) pieChart.destroy();
        pieChart = new Chart(document.getElementById('pieChart'), {
          type: 'doughnut',
          data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 4, borderColor: 'rgba(255,255,255,0.1)' }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff', font: { size: 13 } } } } }
        });
      } catch (e) {
        document.getElementById('compTable').innerHTML = '<tr><td colspan="3" style="text-align:center;padding:2rem;color:var(--muted);">Composition indisponible</td></tr>';
      }
    }

    loadPortfolios();
  </script>
</body>
</html>
