<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AltInvest Capital - Portefeuilles</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    :root {--navy:#0f172a;--gold:#ca8a04;--slate:#64748b;--light:#f8fafc;--gray:#e2e8f0;--red:#dc2626;--green:#16a34a}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#fff;color:#1e293b;padding-top:90px}
    nav{position:fixed;top:0;width:100%;background:var(--navy);padding:1.5rem 0;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,0.3)}
    .nav{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 5rem}
    .logo{font-size:2.4rem;font-weight:900;color:white}.logo span{color:var(--gold)}
    .links a{color:white;text-decoration:none;margin:0 2rem;font-weight:500;transition:.3s}
    .links a:hover,.links a.active{color:var(--gold)}
    .container{max-width:1400px;margin:0 auto;padding:120px 2rem 80px;text-align:center}
    h1{font-size:3.6rem;font-weight:800;margin-bottom:4rem;background:linear-gradient(90deg,var(--navy),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(460px,1fr));gap:2.5rem;margin-top:3rem}
    .card{background:white;border-radius:24px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.08);transition:all .4s;cursor:pointer}
    .card:hover{transform:translateY(-16px);box-shadow:0 30px 70px rgba(0,0,0,0.15)}
    .card-header{background:linear-gradient(135deg,var(--navy),#1e40af);padding:3rem 2rem;color:white;text-align:center}
    .card-header h3{font-size:2.2rem;font-weight:700}
    .metrics{padding:2.5rem;display:grid;grid-template-columns:repeat(3,1fr);gap:1.2rem}
    .kpi{text-align:center;padding:1rem;background:var(--light);border-radius:14px}
    .kpi strong{display:block;font-size:2rem;font-weight:800;color:var(--gold)}
    .kpi.red strong{color:var(--red)}.kpi.green strong{color:var(--green)}
    .kpi small{font-size:0.85rem;color:var(--slate);display:block;margin-top:4px}
    #modal{display:none;position:fixed;inset:0;background:rgba(15,23,42,0.97);backdrop-filter:blur(16px);z-index:2000;align-items:center;justify-content:center;padding:2rem;overflow-y:auto}
    #modal.active{display:flex}
    .modal-content{background:white;border-radius:28px;max-width:1400px;width:95%;max-height:95vh;overflow-y:auto;box-shadow:0 40px 100px rgba(0,0,0,0.5)}
    .modal-header{background:var(--navy);color:white;padding:2rem 3rem;display:flex;justify-content:space-between;align-items:center}
    .modal-header h2{font-size:2.4rem;font-weight:800}
    .close{font-size:3rem;cursor:pointer;opacity:0.8;transition:.3s}
    .close:hover{opacity:1;transform:rotate(90deg)}
    .modal-body{padding:3rem 4rem 4rem}
    .kpi-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:1.5rem;margin-bottom:3rem}
    .kpi-big{background:var(--light);padding:1.8rem;border-radius:18px;text-align:center;border-left:6px solid var(--gold)}
    .kpi-big.red{border-left-color:var(--red)}.kpi-big.red strong{color:var(--red)}
    .kpi-big strong{font-size:2.5rem;font-weight:800;color:var(--gold);display:block}
    .kpi-big div{font-size:0.95rem;color:var(--slate);margin-top:6px}
    .chart-wrapper{position:relative;height:400px !important;background:white;border-radius:20px;padding:1.5rem;box-shadow:0 10px 40px rgba(0,0,0,0.07);margin:3rem 0}
    .chart-controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:15px}
    .chart-btn{padding:9px 16px;border:none;border-radius:10px;background:#e2e8f0;color:#1e293b;font-size:0.95rem;cursor:pointer;transition:.2s;font-weight:600}
    .chart-btn.active,.chart-btn:hover{background:var(--gold);color:white}
    .comp-grid{display:grid;grid-template-columns:1fr 1fr;gap:3rem;margin-top:3rem;align-items:start}
    @media (max-width:992px){.comp-grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:0.9rem;text-align:left;border-bottom:1px solid var(--gray)}
    th{background:var(--light);font-weight:600;color:var(--navy)}
  </style>
</head>
<body>

  <nav><div class="nav"><div class="logo">AltInvest<span>.</span></div><div class="links">
    <a href="index.html">Accueil</a>
    <a href="#" class="active">Portefeuilles</a>
    <a href="devis.html">Devis</a>
    <a href="contact.html">Contact</a>
    <a href="admin.html">Admin</a>
  </div></div></nav>

  <div class="container">
    <h1>Nos Portefeuilles d'Investissement</h1>
    <div class="grid" id="grid"></div>
  </div>

  <div id="modal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="modal-title"></h2><span class="close" onclick="closeModal()">x</span></div>
      <div class="modal-body">
        <div class="kpi-bar" id="kpi-bar"></div>
        <div class="chart-wrapper"><div class="chart-controls" id="mainControls"></div><canvas id="mainChart"></canvas></div>
        <div class="chart-wrapper"><div class="chart-controls" id="detailControls"></div><canvas id="detailChart"></canvas></div>
        <h3 style="text-align:center;margin:4rem 0 2rem;font-size:2rem;font-weight:700;">Composition Actuelle</h3>
        <div class="comp-grid">
          <div class="chart-wrapper" style="height:350px;"><canvas id="pieChart"></canvas></div>
          <table><thead><tr><th>Actif</th><th>Ticker</th><th style="text-align:right;">Pondération</th></tr></thead><tbody id="compTable"></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = "https://raw.githubusercontent.com/BQ-Python/portfolio-data/main/";
    const PORTFOLIOS_JSON = BASE_URL + "portfolios.json";
    const COMP_CSV = BASE_URL + "composition_portefeuilles.csv";
    const RISK_FREE_RATE = 4.0;

    let PORTFOLIOS = [];
    let rawData = [], mainChart = null, detailChart = null, pieChart = null;
    let currentPortfolioName = "";

    function closeModal(){document.getElementById('modal').classList.remove('active');document.body.style.overflow='';[mainChart,detailChart,pieChart].forEach(c=>c?.destroy())}
    function resizeCanvas(c){if(c)setTimeout(()=>{c.resize();c.update()},100)}

    function parseLine(line){
      const cols = line.split(',').map(s=>s.trim().replace(/^"|"$/g,''));
      if(cols.length<9) return null;
      const date = new Date(cols[0]);
      if(isNaN(date)) return null;
      return {
        date,
        port: parseFloat(cols[1])||0,
        sp:   parseFloat(cols[2])||0,
        nas:  parseFloat(cols[3])||0,
        ddC:  parseFloat(cols[7])||0,
        ddM:  parseFloat(cols[8])||0
      };
    }

    // VRAIE VOLATILITÉ ANNUALISÉE SANS INFINITY
    function computeTrueAnnualizedVol(data){
      if(data.length < 50) return 0;
      const returns = [];
      for(let i=1;i<data.length;i++){
        const prev = data[i-1].port;
        const curr = data[i].port;
        if(prev === 0) continue;
        returns.push((curr / prev) - 1);
      }
      if(returns.length < 10) return 0;
      const mean = returns.reduce((a,b)=>a+b,0)/returns.length;
      const variance = returns.reduce((sum,r)=>sum+(r-mean)**2,0)/(returns.length-1);
      const vol = Math.sqrt(variance) * Math.sqrt(252) * 100;
      return isFinite(vol) ? vol : 0;
    }

    function computeCAGR(data){
      if(data.length<2) return 0;
      const first = data[0].port;
      const last = data[data.length-1].port;
      const days = (data[data.length-1].date - data[0].date)/(1000*60*60*24);
      const years = days/365.25;
      return years>0 ? (Math.pow(last/first,1/years)-1)*100 : 0;
    }

    async function loadPortfolios(){
      try{
        const res = await fetch(PORTFOLIOS_JSON);
        PORTFOLIOS = await res.json();
        PORTFOLIOS = PORTFOLIOS.map(p=>({...p,csv:BASE_URL+p.file}));
        await loadCards();
      }catch(e){console.error(e)}
    }

    async function loadCards(){
      const grid = document.getElementById('grid');
      grid.innerHTML='';
      const year = new Date().getFullYear();

      for(const p of PORTFOLIOS){
        try{
          const text = await fetch(p.csv).then(r=>r.text());
          const data = text.trim().split('\n').slice(1).map(parseLine).filter(Boolean);
          if(data.length===0) continue;

          const last = data[data.length-1];
          const firstY = data.find(d=>d.date.getFullYear()===year)||data[0];
          const ytd = ((last.port/firstY.port)-1)*100;
          const cagr = computeCAGR(data);
          const vol = computeTrueAnnualizedVol(data);
          const sharpe = vol>0 ? ((cagr-RISK_FREE_RATE)/vol).toFixed(2) : "N/A";

          const card = document.createElement('div');
          card.className='card';
          card.onclick=()=>openModal(p.name,p.csv);
          card.innerHTML=`
            <div class="card-header"><h3>${p.name}</h3></div>
            <div class="metrics">
              <div class="kpi"><strong>${last.port.toFixed(1)}%</strong><small>Perf. cumulée</small></div>
              <div class="kpi"><strong class="${ytd>=0?'green':'red'}">${ytd.toFixed(1)}%</strong><small>YTD ${year}</small></div>
              <div class="kpi"><strong>${cagr.toFixed(1)}%</strong><small>Perf. annualisée</small></div>
              <div class="kpi"><strong>${vol.toFixed(1)}%</strong><small>Volatilité</small></div>
              <div class="kpi red"><strong>${last.ddM.toFixed(1)}%</strong><small>Drawdown max</small></div>
              <div class="kpi"><strong>${sharpe}</strong><small>Sharpe</small></div>
            </div>`;
          grid.appendChild(card);
        }catch(e){console.error(e)}
      }
    }

    async function openModal(name,url){
      closeModal();
      currentPortfolioName=name;
      document.getElementById('modal-title').textContent=name;
      document.getElementById('modal').classList.add('active');
      document.body.style.overflow='hidden';

      const text = await fetch(url).then(r=>r.text());
      rawData = text.trim().split('\n').slice(1).map(parseLine).filter(Boolean);

      updateKPIs();
      drawMainChart();
      drawDetailChart();
      await loadComposition(name);
    }

    function updateKPIs(){
      const last = rawData[rawData.length-1];
      const year = new Date().getFullYear();
      const firstY = rawData.find(d=>d.date.getFullYear()===year)||rawData[0];
      const ytd = ((last.port/firstY.port)-1)*100;
      const cagr = computeCAGR(rawData);
      const vol = computeTrueAnnualizedVol(rawData);
      const sharpe = vol>0 ? ((cagr-RISK_FREE_RATE)/vol).toFixed(2) : "N/A";

      document.getElementById('kpi-bar').innerHTML=`
        <div class="kpi-big"><strong>${last.port.toFixed(1)}%</strong><div>Perf. cumulée</div></div>
        <div class="kpi-big"><strong class="${ytd>=0?'':'red'}">${ytd.toFixed(1)}%</strong><div>YTD ${year}</div></div>
        <div class="kpi-big"><strong>${cagr.toFixed(1)}%</strong><div>Perf. annualisée</div></div>
        <div class="kpi-big"><strong>${vol.toFixed(1)}%</strong><div>Volatilité annualisée</div></div>
        <div class="kpi-big red"><strong>${last.ddM.toFixed(1)}%</strong><div>Drawdown max</div></div>
        <div class="kpi-big"><strong>${sharpe}</strong><div>Ratio de Sharpe</div></div>`;
    }

    // Le reste du code (graphiques, composition) est identique à la version précédente
    // Je l’ai laissé intact pour ne pas alourdir le message

    loadPortfolios();
  </script>
</body>
</html>
