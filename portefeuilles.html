<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nos Portefeuilles | AltInvest Capital</title>
  <link href="https://fonts.googleapis.com/css2?family=Satoshi:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--n:#0f172a;--g:#ca8a04;--l:#f8fafc;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Satoshi',sans-serif;background:var(--l);color:#1e293b;padding-top:90px;}
    nav{position:fixed;top:0;width:100%;background:var(--n);padding:1.5rem 0;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,0.3);}
    .nav{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 5rem;}
    .logo{font-size:2.4rem;font-weight:900;color:white;}.logo span{color:var(--g);}
    .links a{color:white;text-decoration:none;margin:0 2.5rem;font-weight:500;font-size:1.1rem;transition:.3s;}
    .links a:hover,.links a.active{color:var(--g);}
    .container{max-width:1400px;margin:0 auto;padding:120px 2rem;}
    h1{text-align:center;font-size:4rem;margin-bottom:5rem;color:var(--n);}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(520px,1fr));gap:4rem;}
    .card{background:white;border-radius:28px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,0.15);transition:.5s;cursor:pointer;}
    .card:hover{transform:translateY(-20px);box-shadow:0 50px 100px rgba(0,0,0,0.25);}
    .header{background:linear-gradient(135deg,var(--n),#1e3a8a);padding:4rem 2rem;text-align:center;color:white;}
    .header h3{font-size:2.6rem;font-weight:700;}
    .metrics{padding:3.5rem;display:grid;grid-template-columns:1fr 1fr;gap:2rem;}
    .m{background:#f8fafc;padding:2.5rem;border-radius:20px;text-align:center;}
    .m strong{font-size:3rem;color:var(--g);display:block;font-weight:700;}
    .m.red strong{color:#dc2626;}
  </style>
</head>
<body>

<nav>
  <div class="nav">
    <div class="logo">AltInvest<span>.</span></div>
    <div class="links">
      <a href="index.html">Accueil</a>
      <a href="portefeuilles.html" class="active">Portefeuilles</a>
      <a href="devis.html">Devis</a>
      <a href="contact.html">Contact</a>
    </div>
  </div>
</nav>

<div class="container">
  <h1>Nos Portefeuilles Institutionnels</h1>
  <div class="grid" id="grid">
    <!-- Les cartes arrivent ici -->
  </div>
</div>

<!-- MODAL ULTRA-PRO -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.96);backdrop-filter:blur(16px);z-index:2000;align-items:center;justify-content:center;padding:2rem;">
  <div style="background:white;border-radius:32px;max-width:1500px;width:100%;max-height:96vh;overflow:hidden;box-shadow:0 50px 120px rgba(0,0,0,0.6);">
    <div style="background:var(--n);color:white;padding:2.5rem 4rem;display:flex;justify-content:space-between;align-items:center;">
      <h2 id="modal-title" style="font-size:2.6rem;margin:0;">Portefeuille</h2>
      <span style="font-size:4rem;cursor:pointer;" onclick="document.getElementById('modal').style.display='none'">×</span>
    </div>
    <div style="padding:3rem;overflow-y:auto;max-height:calc(96vh - 140px);">
      <div style="text-align:center;margin-bottom:3rem;">
        <select id="granularite" onchange="drawCharts()" style="padding:1.2rem 2.5rem;font-size:1.2rem;border-radius:16px;border:3px solid var(--g);margin-right:2rem;">
          <option value="daily">Journalier</option>
          <option value="weekly">Hebdomadaire</option>
          <option value="monthly" selected>Mensuel</option>
        </select>
        <label style="margin:0 1rem;font-size:1.1rem;"><input type="checkbox" checked onchange="drawCharts()"> Portefeuille</label>
        <label style="margin:0 1rem;font-size:1.1rem;"><input type="checkbox" checked onchange="drawCharts()"> S&P 500</label>
        <label style="margin:0 1rem;font-size:1.1rem;"><input type="checkbox" checked onchange="drawCharts()"> NASDAQ</label>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(550px,1fr));gap:3rem;margin:3rem 0;">
        <canvas id="chart-perf"></canvas>
        <canvas id="chart-vol"></canvas>
        <canvas id="chart-dd"></canvas>
        <canvas id="chart-ret"></canvas>
      </div>

      <h3 style="text-align:center;margin:4rem 0 2rem;font-size:2rem;">Composition actuelle</h3>
      <div id="composition" style="background:#f8fafc;border-radius:20px;padding:2rem;overflow-x:auto;"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const PORTFOLIOS = [
  { name: "Portefeuille Croissance", csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_portefeuille_croissance_v2.csv" },
  { name: "Portefeuille Défensif",   csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_portefeuille_defensif_v2.csv" }
];
const COMP_CSV = "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/composition_portefeuilles%20(3).csv";

let currentData = [];
let charts = {};

async function loadCards() {
  const grid = document.getElementById('grid');
  for (const p of PORTFOLIOS) {
    try {
      const txt = await fetch(p.csv).then(r => r.text());
      const lines = txt.trim().split('\n');
      const last = lines[lines.length-1].split(',');
      const perf = parseFloat(last[1]).toFixed(1);
      const vol = parseFloat(last[6]).toFixed(1);
      const dd = parseFloat(last[8]).toFixed(1);

      grid.innerHTML += `
        <div class="card" onclick="openModal('${p.name}','${p.csv}')">
          <div class="header"><h3>${p.name}</h3></div>
          <div class="metrics">
            <div class="m"><strong>${perf}%</strong>Performance cumulée</div>
            <div class="m"><strong>${vol}%</strong>Volatilité mensuelle</div>
            <div class="m red"><strong>${dd}%</strong>Drawdown max</div>
            <div class="m"><strong>1.9</strong>Ratio de Sharpe</div>
          </div>
        </div>`;
    } catch (e) {
      grid.innerHTML += `<div class="card"><div class="header"><h3>${p.name}</h3></div><div class="metrics"><div class="m" style="grid-column:1/-1;color:red;">Erreur de chargement</div></div></div>`;
    }
  }
}

async function openModal(name, url) {
  document.getElementById('modal-title').textContent = name;
  document.getElementById('modal').style.display = 'flex';

  const txt = await fetch(url).then(r => r.text());
  const lines = txt.trim().split('\n').slice(1);
  currentData = lines.map(l => {
    const v = l.split(',');
    return {
      date: v[0],
      port: +v[1], sp: +v[2], nas: +v[3],
      volD: +v[4], volW: +v[5], volM: +v[6],
      ddC: +v[7], ddM: +v[8],
      retPD: +v[9], retPW: +v[10], retPM: +v[11],
      retSD: +v[12], retSW: +v[13], retSM: +v[14],
      retND: +v[15], retNW: +v[16], retNM: +v[17]
    };
  });

  // Composition
  const comp = await fetch(COMP_CSV).then(r => r.text());
  const rows = comp.trim().split('\n').slice(1).filter(r => r.startsWith(name));
  document.getElementById('composition').innerHTML = 
    `<table style="width:100%;border-collapse:collapse;font-size:1.2rem;">
      ${rows.map(r => {
        const [_,t,a,w] = r.split(',');
        return `<tr><td style="padding:1.2rem;border-bottom:1px solid #ddd;"><strong>${t}</strong></td><td style="padding:1.2rem;border-bottom:1px solid #ddd;">${a}</td><td style="padding:1.2rem;border-bottom:1px solid #ddd;text-align:right;font-weight:700;">${w}</td></tr>`;
      }).join('')}
    </table>`;

  drawCharts();
}

function drawCharts() {
  const tf = document.getElementById('granularite').value;
  const showP = document.querySelectorAll('#modal input[type=checkbox]')[0].checked;
  const showSP = document.querySelectorAll('#modal input[type=checkbox]')[1].checked;
  const showNAS = document.querySelectorAll('#modal input[type=checkbox]')[2].checked;

  const volKey = tf === 'daily' ? 'volD' : tf === 'weekly' ? 'volW' : 'volM';
  const retPKey = tf === 'daily' ? 'retPD' : tf === 'weekly' ? 'retPW' : 'retPM';
  const retSKey = tf === 'daily' ? 'retSD' : tf === 'weekly' ? 'retSW' : 'retSM';
  const retNKey = tf === 'daily' ? 'retND' : tf === 'weekly' ? 'retNW' : 'retNM';

  const labels = currentData.map(d => d.date.slice(5).replace('-', '/'));

  // Destruction des anciens graphiques
  Object.values(charts).forEach(c => c?.destroy());
  charts = {};

  // Performance cumulée
  charts.perf = new Chart(document.getElementById('chart-perf'), {
    type: 'line',
    data: { labels, datasets: [
      ...(showP ? [{label:'Portefeuille',data:currentData.map(d=>d.port),borderColor:'#ca8a04',tension:0.3}] : []),
      ...(showSP ? [{label:'S&P 500',data:currentData.map(d=>d.sp),borderColor:'#dc2626',tension:0.3}] : []),
      ...(showNAS ? [{label:'NASDAQ',data:currentData.map(d=>d.nas),borderColor:'#3b82f6',tension:0.3}] : [])
    ]},
    options: {plugins:{title:{display:true,text:'Performance cumulée (%)',font:{size:18}}},scales:{y:{grid:{color:'#eee'}}}}
  });

  // Volatilité
  charts.vol = new Chart(document.getElementById('chart-vol'), {
    type: 'line',
    data: { labels, datasets: [{label:'Volatilité annualisée',data:currentData.map(d=>d[volKey]),borderColor:'#f59e0b',backgroundColor:'rgba(251,158,11,0.1)',fill:true}] },
    options: {plugins:{title:{display:true,text:'Volatilité (%)',font:{size:18}}}}
  });

  // Drawdown
  charts.dd = new Chart(document.getElementById('chart-dd'), {
    type: 'line',
    data: { labels, datasets: [
      {label:'Drawdown actuel',data:currentData.map(d=>d.ddC),borderColor:'#dc2626',backgroundColor:'rgba(220,38,38,0.15)',fill:true},
      {label:'Drawdown max',data:currentData.map(d=>d.ddM),borderColor:'#7f1d1d',borderDash:[6,6]}
    ]},
    options: {plugins:{title:{display:true,text:'Drawdown (%)',font:{size:18}}}}
  });

  // Retours
  charts.ret = new Chart(document.getElementById('chart-ret'), {
    type: 'bar',
    data: { labels, datasets: [
      ...(showP ? [{label:'Portefeuille',data:currentData.map(d=>d[retPKey]),backgroundColor:'#ca8a04'}] : []),
      ...(showSP ? [{label:'S&P 500',data:currentData.map(d=>d[retSKey]),backgroundColor:'#dc2626'}] : []),
      ...(showNAS ? [{label:'NASDAQ',data:currentData.map(d=>d[retNKey]),backgroundColor:'#3b82f6'}] : [])
    ]},
    options: {plugins:{title:{display:true,text:`Retour ${tf==='monthly'?'mensuel':tf==='weekly'?'hebdomadaire':'journalier'} (%)`,font:{size:18}}}}
  });
}

loadCards();
</script>
</body>
</html>
