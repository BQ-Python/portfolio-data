<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Portefeuilles optimisés Croissance & Défensif - Performances, volatilité, drawdown et retours mensuels comparés aux indices.">
  <title>Portefeuilles Financiers Professionnels</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root { --primary: #10b981; --primary-dark: #059669; --gray-100: #f3f4f6; --gray-900: #111827; --danger: #ef4444; }
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f9fafb; color: #111; margin: 0; line-height: 1.6; }
    header { background: var(--primary); color: white; padding: 1.5rem; text-align: center; font-size: 1.9rem; font-weight: 700; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .container { max-width: 1300px; margin: 0 auto; padding: 2rem 1rem; }
    h2 { text-align: center; font-size: 2.2rem; margin: 3rem 0 2rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 2rem; margin: 2rem 0; }
    .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: all 0.3s ease; }
    .card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
    .card-header { background: var(--primary); color: white; padding: 1.5rem; text-align: center; font-size: 1.5rem; font-weight: 600; }
    .card-body { padding: 1.8rem; }
    .metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
    .metric { background: var(--gray-100); padding: 1rem; border-radius: 12px; text-align: center; }
    .metric strong { display: block; font-size: 1.6rem; color: var(--primary); font-weight: 600; }
    .btn { width: 100%; background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .btn:hover { background: var(--primary-dark); }

    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 20px; max-width: 1300px; width: 100%; max-height: 95vh; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.3); }
    .modal-header { padding: 1.5rem 2rem; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { margin: 0; font-size: 1.8rem; }
    .close { font-size: 2.5rem; cursor: pointer; }
    .modal-body { padding: 2rem; overflow-y: auto; max-height: calc(95vh - 100px); }
    .controls { text-align: center; margin-bottom: 2rem; }
    .controls select { padding: 0.8rem 1.5rem; font-size: 1.1rem; border-radius: 12px; border: 2px solid var(--primary); }
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 2rem; margin: 2rem 0; }
    canvas { background: white; border-radius: 16px; padding: 1rem; box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
    table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
    th, td { border: 1px solid #ddd; padding: 1rem; text-align: center; }
    th { background: var(--primary); color: white; font-weight: 600; }
    footer { background: var(--gray-900); color: white; text-align: center; padding: 2rem; margin-top: 5rem; }
  </style>
</head>
<body>

<header>Portefeuilles Financiers Professionnels</header>

<div class="container">
  <h2>Nos Portefeuilles Optimisés</h2>
  <div class="grid" id="portfolio-grid"></div>

  <h2>Demandez une Analyse Gratuite</h2>
  <form id="contact-form" style="max-width:600px;margin:3rem auto;background:white;padding:2.5rem;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.1);">
    <input type="text" name="nom" placeholder="Votre nom" required style="width:100%;padding:1rem;margin-bottom:1rem;border-radius:12px;border:1px solid #ddd;">
    <input type="email" name="email" placeholder="Votre email" required style="width:100%;padding:1rem;margin-bottom:1rem;border-radius:12px;border:1px solid #ddd;">
    <select name="portefeuille" required style="width:100%;padding:1rem;margin-bottom:1rem;border-radius:12px;border:1px solid #ddd;">
      <option value="" disabled selected>Choisir un portefeuille</option>
      <option>Portefeuille Croissance</option>
      <option>Portefeuille Défensif</option>
    </select>
    <textarea name="message" placeholder="Vos objectifs, horizon, tolérance au risque..." style="width:100%;padding:1rem;min-height:120px;margin-bottom:1rem;border-radius:12px;border:1px solid #ddd;"></textarea>
    <button type="submit" class="btn">Envoyer la demande</button>
  </form>
</div>

<!-- Modal -->
<div class="modal" id="details-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title"></h2>
      <span class="close" onclick="Modal.close()" aria-label="Fermer">×</span>
    </div>
    <div class="modal-body">
      <div class="controls">
        <label for="timeframe"><strong>Période d'analyse :</strong></label>
        <select id="timeframe" onchange="Modal.updateAllCharts()">
          <option value="daily">Journalier</option>
          <option value="weekly">Hebdomadaire</option>
          <option value="monthly" selected>Mensuel</option>
        </select>
      </div>

      <div class="charts-grid">
        <div><h3 style="text-align:center;margin:1rem 0;">Performance Cumulée</h3><canvas id="chart-performance"></canvas></div>
        <div><h3 style="text-align:center;margin:1rem 0;">Volatilité Annualisée</h3><canvas id="chart-volatility"></canvas></div>
        <div><h3 style="text-align:center;margin:1rem 0;">Drawdown</h3><canvas id="chart-drawdown"></canvas></div>
        <div><h3 style="text-align:center;margin:1rem 0;">Retour sur la Période</h3><canvas id="chart-returns"></canvas></div>
      </div>

      <h3 style="margin-top:3rem;">Composition Actuelle</h3>
      <table id="composition-table"><thead><tr><th>Ticker</th><th>Actif</th><th>Poids</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<footer>© 2025 Portefeuilles Financiers – Tous droits réservés</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const PORTFOLIOS = [
  { name: "Portefeuille Croissance", csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_croissance_v2.csv" },
  { name: "Portefeuille Défensif",   csv: "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/portefeuille_defensif_v2.csv" }
];
const COMPOSITION_CSV = "https://raw.githubusercontent.com/BQ-Python/portfolio-data/refs/heads/main/composition_portefeuilles%20(1).csv";

let currentData = [];
let charts = {};

const Modal = {
  async open(name, csvUrl) {
    document.getElementById('modal-title').textContent = name;
    document.getElementById('details-modal').classList.add('active');
    document.body.style.overflow = 'hidden';

    try {
      const text = await fetch(csvUrl).then(r => r.text());
      const lines = text.trim().split('\n');
      currentData = lines.slice(1).filter(r => r.trim()).map(row => {
        const v = row.split(',');
        return {
          date: v[0],
          portfolio: parseFloat(v[1]) * 100,
          sp500: parseFloat(v[2]) * 100,
          nasdaq: parseFloat(v[3]) * 100,
          volDaily: parseFloat(v[4]) * 100,
          volWeekly: parseFloat(v[5]) * 100,
          volMonthly: parseFloat(v[6]) * 100,
          ddCurrent: parseFloat(v[7]) * 100,
          ddMax: parseFloat(v[8]) * 100,
          retPort: parseFloat(v[9]) * 100,
          retSP: parseFloat(v[10]) * 100,
          retNasdaq: parseFloat(v[11]) * 100,
        };
      });

      this.updateAllCharts();
      this.loadComposition(name);
    } catch (err) {
      alert("Impossible de charger les données. Vérifie le format du CSV (10+ colonnes).");
    }
  },

  updateAllCharts() {
    const tf = document.getElementById('timeframe').value;
    const volKey = tf === 'daily' ? 'volDaily' : tf === 'weekly' ? 'volWeekly' : 'volMonthly';
    const labels = currentData.map(d => d.date.split('T')[0]);

    // Destruction des anciens graphiques
    Object.values(charts).forEach(c => c?.destroy());
    charts = {};

    // 1. Performance cumulée
    charts.perf = new Chart(document.getElementById('chart-performance'), {
      type: 'line',
      data: { labels, datasets: [
        { label: 'Portefeuille', data: currentData.map(d => d.portfolio), borderColor: '#10b981', tension: 0.3 },
        { label: 'S&P 500', data: currentData.map(d => d.sp500), borderColor: '#ef4444', tension: 0.3 },
        { label: 'NASDAQ', data: currentData.map(d => d.nasdaq), borderColor: '#3b82f6', tension: 0.3 }
      ]},
      options: { responsive: true, plugins: { legend: { position: 'top' }}, scales: { y: { title: { display: true, text: 'Performance cumulée (%)' }}}}
    });

    // 2. Volatilité
    charts.vol = new Chart(document.getElementById('chart-volatility'), {
      type: 'line',
      data: { labels, datasets: [{ label: 'Volatilité', data: currentData.map(d => d[volKey]), borderColor: '#f59e0b', fill: true, backgroundColor: 'rgba(251,146,60,0.1)' }]},
      options: { responsive: true, scales: { y: { title: { display: true, text: 'Volatilité (%)' }}}}
    });

    // 3. Drawdown
    charts.dd = new Chart(document.getElementById('chart-drawdown'), {
      type: 'line',
      data: { labels, datasets: [
        { label: 'Drawdown actuel', data: currentData.map(d => d.ddCurrent), borderColor: '#dc2626', fill: true, backgroundColor: 'rgba(220,38,38,0.15)' },
        { label: 'Drawdown max', data: currentData.map(d => d.ddMax), borderColor: '#7f1d1d', borderDash: [6,6] }
      ]},
      options: { responsive: true, scales: { y: { title: { display: true, text: 'Drawdown (%)' }}}}
    });

    // 4. Retour sur la période choisie (journalier/hebdo/mensuel)
    charts.returns = new Chart(document.getElementById('chart-returns'), {
      type: 'bar',
      data: { labels, datasets: [
        { label: 'Portefeuille', data: currentData.map(d => d.retPort), backgroundColor: '#10b981' },
        { label: 'S&P 500', data: currentData.map(d => d.retSP), backgroundColor: '#ef4444' },
        { label: 'NASDAQ', data: currentData.map(d => d.retNasdaq), backgroundColor: '#3b82f6' }
      ]},
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' }},
        scales: { y: { title: { display: true, text: `Retour ${tf === 'daily' ? 'journalier' : tf === 'weekly' ? 'hebdomadaire' : 'mensuel'} (%)` }}}
      }
    });
  },

  async loadComposition(name) {
    const text = await fetch(COMPOSITION_CSV).then(r => r.text());
    const rows = text.trim().split('\n').slice(1);
    const tbody = document.querySelector('#composition-table tbody');
    tbody.innerHTML = '';
    rows.forEach(row => {
      const [portfolio, ticker, asset, weight] = row.split(',');
      if (portfolio?.trim() === name) {
        tbody.innerHTML += `<tr><td><strong>${ticker}</strong></td><td>${asset}</td><td>${weight}%</td></tr>`;
      }
    });
  },

  close() {
    document.getElementById('details-modal').classList.remove('active');
    document.body.style.overflow = '';
    Object.values(charts).forEach(c => c?.destroy());
    charts = {};
  }
};

// Fermeture modal
window.addEventListener('click', e => { if (e.target === document.getElementById('details-modal')) Modal.close(); });
window.addEventListener('keydown', e => { if (e.key === 'Escape') Modal.close(); });

// Chargement des cartes (inchangé)
async function loadCards() {
  const grid = document.getElementById('portfolio-grid');
  grid.innerHTML = PORTFOLIOS.map(() => `<div class="card"><div class="card-header" style="background:#ccc;height:80px;"></div><div class="card-body"><div class="metrics">${'<div class="metric" style="background:#eee;height:90px;"></div>'.repeat(4)}</div><div class="btn" style="background:#ccc;height:56px;"></div></div></div>`).join('');

  for (const p of PORTFOLIOS) {
    try {
      const text = await fetch(p.csv).then(r => r.text());
      const lines = text.trim().split('\n');
      const last = lines[lines.length - 1].split(',');
      const perf = (parseFloat(last[1]) * 100).toFixed(2);
      const vol = (parseFloat(last[6]) * 100).toFixed(2);
      const dd = (parseFloat(last[7]) * 100).toFixed(2);

      const card = `<div class="card">
        <div class="card-header">${p.name}</div>
        <div class="card-body">
          <div class="metrics">
            <div class="metric"><strong>${perf}%</strong> Perf.</div>
            <div class="metric"><strong>${vol}%</strong> Vol.</div>
            <div class="metric"><strong>${dd}%</strong> DD</div>
            <div class="metric"><strong>1.8</strong> Sharpe</div>
          </div>
          <button class="btn" onclick="Modal.open('${p.name}', '${p.csv}')">Détails complets</button>
        </div>
      </div>`;
      grid.innerHTML += card;
    } catch (e) { console.error(e); }
  }
  // Nettoyage des skeletons
  grid.innerHTML = grid.innerHTML.replace(/style="[^"]*background:#ccc[^"]*"/g, '');
}

loadCards();
</script>
</body>
</html>
